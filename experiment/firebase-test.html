<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Experiment</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; max-width: 600px; margin: 2rem auto; text-align: center; }
    button { font-size: 1rem; margin: 1rem; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; }
    input, select, textarea { margin: 0.4rem; padding: 0.4rem; width: 80%; }
    section { display: none; }
    section.active { display: block; }
    #status { font-style: italic; height: 1.5rem; }
    audio { margin-top: 1rem; width: 100%; }

    .dots { display: inline-block; width: 3rem; text-align: center; }
    .dots span { display: inline-block; width: 0.5rem; height: 0.5rem; margin: 0 0.1rem; background-color: #555; border-radius: 50%; animation: blink 1.4s infinite both; }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink { 0%,80%,100%{opacity:0;} 40%{opacity:1;} }
  </style>
</head>

<body>

  <!-- PRE-SURVEY -->
  <section id="preSurvey" class="active">
    <input id="age" type="number" placeholder="Age" /><br>
    <select id="gender">
      <option value="">Gender</option>
      <option>Female</option>
      <option>Male</option>
      <option>Non-binary</option>
      <option>Other</option>
    </select><br>
    <button id="startBtn">Continue</button>
  </section>

  <!-- INTERACTION -->
  <section id="interaction">
    <button id="recordBtn">üé§ Start Recording</button>
    <p id="status"></p>
    <audio id="responseAudio" controls></audio><br>
    <button id="surveyBtn" style="display:none;">üìù Survey</button>
  </section>

  <!-- POST-SURVEY -->
  <section id="postSurvey">
    <select id="satisfaction">
      <option value="">Select rating</option>
      <option value="1">1 - Very negative</option>
      <option value="2">2 - Negative</option>
      <option value="3">3 - Neutral</option>
      <option value="4">4 - Positive</option>
      <option value="5">5 - Very positive</option>
    </select><br>
    <textarea id="feedback" rows="3" placeholder="Any comments..."></textarea><br>
    <button id="submitBtn">Submit</button>
  </section>

  <!-- THANK YOU -->
  <section id="thanks">
    <h2>Thank you</h2>
  </section>

<script>
/* ===============================
   Firebase Init
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyBDOb-3I8TD3ZjBxtqyQNBF8YFIuIAdsKc",
  authDomain: "slm-experiment-dev.firebaseapp.com",
  projectId: "slm-experiment-dev",
  storageBucket: "slm-experiment-dev.firebasestorage.app",
  messagingSenderId: "762879513861",
  appId: "1:762879513861:web:3b67a55dc2ba727308536c",
  measurementId: "G-9WYB65Z78J"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* ===============================
   Variables
================================ */
let userId = null;
let condition = null;

const preSurvey = document.getElementById("preSurvey");
const interaction = document.getElementById("interaction");
const postSurvey = document.getElementById("postSurvey");
const thanks = document.getElementById("thanks");
const recordBtn = document.getElementById("recordBtn");
const surveyBtn = document.getElementById("surveyBtn");
const statusEl = document.getElementById("status");
const responseAudio = document.getElementById("responseAudio");

/* ===============================
   PRE-SURVEY
================================ */
document.getElementById("startBtn").onclick = async () => {
  const age = document.getElementById("age").value.trim();
  const gender = document.getElementById("gender").value.trim();
  if (!age || !gender) return alert("Please complete the survey.");

  condition = Math.random() < 0.5 ? "natural" : "robotic";
  userId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

  await db.collection("users").doc(userId).set({
    userId,
    condition,
    createdAt: new Date(),
    preSurvey: { age, gender, timestamp: new Date() }
  }, { merge: true });

  preSurvey.classList.remove("active");
  interaction.classList.add("active");
};

/* ===============================
   Recording
================================ */
let mediaRecorder, chunks = [];

recordBtn.onclick = async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = handleRecordingStop;
    mediaRecorder.start();

    recordBtn.textContent = "‚èπ Stop Recording";
    statusEl.innerHTML = "";
  } else {
    mediaRecorder.stop();
    recordBtn.textContent = "üé§ Start Recording";
    statusEl.innerHTML = `<div class="dots"><span></span><span></span><span></span></div>`;
  }
};

/* ===============================
   HANDLE RECORDING STOP
   (UPDATED TO UPLOAD ROBOTIC WAV)
================================ */
async function handleRecordingStop() {
  const ts = Date.now();

  // Upload user recording
  const userBlob = new Blob(chunks, { type: "audio/webm" });
  const userRef = storage.ref(`users/${userId}/user_${ts}.webm`);
  await userRef.put(userBlob);
  const userAudioURL = await userRef.getDownloadURL();

  // Call backend
  const response = await fetch("https://callopenai-ks3vpjhzoq-uc.a.run.app", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ audio: userAudioURL, userId })
  });

  const data = await response.json();
  if (data.error) {
    statusEl.textContent = "‚ö†Ô∏è Error: " + data.error;
    return;
  }

  let finalAudioURL = data.audio;
  let roboticAudioURL = null;

  // ===== ROBOTIC CONDITION =====
  if (condition === "robotic") {
    // 1. Apply DSP ‚Üí WAV (local)
    const roboticLocalURL = await applyRoboticEffect(data.audio);

    // 2. Convert local URL ‚Üí Blob
    const roboticBlob = await fetch(roboticLocalURL).then(r => r.blob());

    // 3. Upload robotic WAV
    const roboticFileName = `users/${userId}/robotic_${ts}.wav`;
    const roboticRef = storage.ref(roboticFileName);
    await roboticRef.put(roboticBlob, { contentType: "audio/wav" });

    // 4. Firebase URL
    roboticAudioURL = await roboticRef.getDownloadURL();

    // 5. Play robotic version
    finalAudioURL = roboticAudioURL;
  }

  // Play audio
  responseAudio.src = finalAudioURL;
  surveyBtn.style.display = "inline-block";
  statusEl.innerHTML = "";

  // Save conversation record
  await db.collection("users").doc(userId).collection("conversation").add({
    condition,
    userAudioURL,
    modelAudioURL: data.audio,
    roboticAudioURL: roboticAudioURL || null,
    transcript: data.text || "",
    replyText: data.text || "",
    timestamp: new Date()
  });

  surveyBtn.onclick = () => {
    interaction.classList.remove("active");
    postSurvey.classList.add("active");
  };
}

/* ===============================
   ROBOTIC DSP (Offline ‚Üí WAV)
================================ */
async function applyRoboticEffect(url) {
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();

  const tempCtx = new (window.AudioContext || window.webkitAudioContext)();
  const decoded = await tempCtx.decodeAudioData(arrayBuffer);
  tempCtx.close();

  const offlineCtx = new OfflineAudioContext(
    decoded.numberOfChannels,
    decoded.length,
    decoded.sampleRate
  );

  const src = offlineCtx.createBufferSource();
  src.buffer = decoded;

  // Gentle AM modulation
  const mod = offlineCtx.createOscillator();
  mod.type = "square";
  mod.frequency.value = 90;

  const modGain = offlineCtx.createGain();
  modGain.gain.value = 0.25;

  mod.connect(modGain.gain);
  src.connect(modGain);

  // Highpass
  const hp = offlineCtx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.value = 250;

  modGain.connect(hp);

  // Bitcrusher
  const crusher = offlineCtx.createWaveShaper();
  const bits = 10;
  const steps = 2 ** bits;
  const curve = new Float32Array(65536);
  for (let i = 0; i < 65536; i++) {
    let x = (i / 65536) * 2 - 1;
    curve[i] = Math.round(x * steps) / steps;
  }
  crusher.curve = curve;

  hp.connect(crusher);
  crusher.connect(offlineCtx.destination);

  mod.start(0);
  src.start(0);

  const rendered = await offlineCtx.startRendering();
  return audioBufferToWavURL(rendered);
}

/* ===============================
   WAV EXPORT HELPER
================================ */
function audioBufferToWavURL(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const length = buffer.length * numChannels * 2 + 44;

  const arrayBuffer = new ArrayBuffer(length);
  const view = new DataView(arrayBuffer);

  let pos = 0;
  const write = s => { for (let i = 0; i < s.length; i++) view.setUint8(pos++, s.charCodeAt(i)); };

  write("RIFF");
  view.setUint32(pos, 36 + buffer.length * numChannels * 2, true); pos += 4;
  write("WAVE");
  write("fmt ");
  view.setUint32(pos, 16, true); pos += 4;
  view.setUint16(pos, 1, true); pos += 2;
  view.setUint16(pos, numChannels, true); pos += 2;
  view.setUint32(pos, sampleRate, true); pos += 4;
  view.setUint32(pos, sampleRate * numChannels * 2, true); pos += 4;
  view.setUint16(pos, numChannels * 2, true); pos += 2;
  view.setUint16(pos, 16, true); pos += 2;
  write("data");
  view.setUint32(pos, buffer.length * numChannels * 2, true); pos += 4;

  const channels = [];
  for (let c = 0; c < numChannels; c++) channels.push(buffer.getChannelData(c));

  for (let i = 0; i < buffer.length; i++) {
    for (let c = 0; c < numChannels; c++) {
      let sample = Math.max(-1, Math.min(1, channels[c][i]));
      view.setInt16(pos, sample * 32767, true);
      pos += 2;
    }
  }

  return URL.createObjectURL(new Blob([arrayBuffer], { type: "audio/wav" }));
}

/* ===============================
   POST-SURVEY
================================ */
document.getElementById("submitBtn").onclick = async () => {
  const satisfaction = document.getElementById("satisfaction").value;
  const feedback = document.getElementById("feedback").value.trim();
  if (!satisfaction) return alert("Please rate the response.");

  await db.collection("users").doc(userId).set({
    postSurvey: { satisfaction, feedback, timestamp: new Date() }
  }, { merge: true });

  postSurvey.classList.remove("active");
  thanks.classList.add("active");
};

</script>
</body>
</html>
