<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Experiment</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>



  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 700px;
      margin: 2rem auto;
      text-align: center;
    }
    button {
      font-size: 1rem;
      margin: 1rem;
      padding: 0.6rem 1.2rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    section { display: none; }
    section.active { display: block; }

    #status { font-style: italic; min-height: 1.5rem; }
    audio { margin-top: 1rem; width: 100%; }

    ul { text-align: left; margin: 1rem auto; max-width: 480px; }

    .dots { display: inline-block; width: 3rem; text-align: center; }
    .dots span {
      display: inline-block;
      width: 0.5rem;
      height: 0.5rem;
      margin: 0 0.1rem;
      background-color: #555;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%,80%,100% { opacity: 0; }
      40% { opacity: 1; }
    }

    .trial-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: left;
    }
    .trial-header {
      font-size: 0.9rem;
      color: #8a7a2d;
      margin-bottom: 0.5rem;
    }
    .context-label {
      margin-top: 0.25rem;
      margin-bottom: 0.75rem;
    }
    .context-label span {
      font-style: italic;
    }
    .trial-question {
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 1.5rem 0 1rem 0;
    }
    hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 0.75rem 0;
    }

    .survey-block {
      text-align: left;
      margin: 1rem auto;
      max-width: 520px;
    }
    .survey-block h3 {
      font-size: 1rem;
      margin-bottom: 0.3rem;
    }
    .survey-options {
      margin-left: 0.75rem;
    }
    .survey-options label {
      display: block;
      margin: 0.15rem 0;
    }
  </style>
</head>

<body>

<!-- ===============================
      WELCOME SCREEN (Slide 1)
=============================== -->
<section id="welcome" class="active">
  <h2>Welcome!</h2>

  <p>
    In today’s study, you will interact with a chat system.
  </p>

  <p>
    Hello! The system can answer questions about work, health, and general facts.
  </p>

  <p>
    On each trial, you will click on a button to ask the system a pre-set question
    (e.g., “How far away is the moon?”). Then the system will provide a response.
  </p>

  <p><strong>
    For this study, you will need to be able to see the full screen and listen to audio.
  </strong></p>

  <button id="welcomeContinueBtn">Continue</button>
</section>


<!-- ===============================
      ENVIRONMENT SETUP (Slide 2)
=============================== -->
<section id="environment">
  <h2>Before We Begin</h2>

  <p>Before we begin, you’ll need to set up your environment.</p>

  <ul>
    <li>Quiet room</li>
    <li>No background noise (e.g., dog barking, other people talking, TV on)</li>
    <li>Silence notifications on your computer and phone</li>
  </ul>

  <p><strong>
    Below, click to confirm you have met these environment requirements:
  </strong></p>

  <label style="display:block; text-align:left; max-width:500px; margin:1rem auto;">
    <input type="checkbox" id="envConfirm" />
    I confirm I’m in a quiet room with no background noise and I’ve silenced
    notifications on my computer and phone
  </label>

  <button id="envContinueBtn" disabled>Continue</button>
</section>





<!-- ===============================
      TRIAL INTERACTION
=============================== -->
<section id="interaction">
  <div class="trial-card">
    <div class="trial-header" id="trialCounter">Trial 1 / 20</div>
    <div class="context-label">
      <strong>Context:</strong>
      <span id="trialContext"></span>
    </div>
    <hr />
    <div class="trial-question" id="trialQuestion"></div>

    <div style="text-align:center; margin-top:1rem;">
      <button id="recordBtn">Ask</button>
      <p id="status"></p>
      <audio id="responseAudio" controls></audio><br />
      <button id="surveyBtn" style="display:none;">Continue</button>
    </div>
  </div>
</section>


<!-- ===============================
      AUDIO CALIBRATION
=============================== -->
<section id="audioCalibration">
  <h2>Audio Calibration</h2>

  <p>
    Play the audio below. You can adjust the volume on your device until it is at a
    comfortable listening level.
  </p>

  <p><strong>
    Important! Please keep the level the same throughout the experiment.
  </strong></p>

  <audio id="calibrationAudio" controls>
    <source src="attention_check/audio_check.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <p style="margin-top:1.5rem;">
    After listening, please answer the question below.
  </p>

  <div class="survey-block">
    <h3>What color was mentioned in the recording?</h3>
    <div class="survey-options">
      <label><input type="radio" name="calibrationCheck" value="yellow"> Yellow</label>
      <label><input type="radio" name="calibrationCheck" value="green"> Green</label>
      <label><input type="radio" name="calibrationCheck" value="red"> Red</label>
    </div>
  </div>

  <button id="calibrationContinueBtn">Continue</button>
</section>



<!-- ===============================
      PER-TRIAL SURVEY
=============================== -->
<section id="trialSurvey">
  <h2>Trial Feedback</h2>

  <div class="survey-block">
    <h3>1. How accurate is the system’s response?</h3>
    <div class="survey-options">
      <label><input type="radio" name="accuracy" value="1" /> Not at all accurate</label>
      <label><input type="radio" name="accuracy" value="2" /> Somewhat accurate</label>
      <label><input type="radio" name="accuracy" value="3" /> Mostly accurate</label>
      <label><input type="radio" name="accuracy" value="4" /> Completely accurate</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>2. If you were relying on this information, how risky would it be if the system got this information wrong?</h3>
    <div class="survey-options">
      <label><input type="radio" name="risk" value="1" /> Not at all risky</label>
      <label><input type="radio" name="risk" value="2" /> Neither risky nor unrisky</label>
      <label><input type="radio" name="risk" value="3" /> Somewhat risky</label>
      <label><input type="radio" name="risk" value="4" /> Extremely risky</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>3. Would you validate the system’s answer with other sources?</h3>
    <div class="survey-options">
      <label><input type="radio" name="validate" value="0" /> No</label>
      <label><input type="radio" name="validate" value="1" /> Maybe</label>
      <label><input type="radio" name="validate" value="2" /> Yes</label>
    </div>
  </div>

  <button id="trialSurveyNextBtn">Next</button>
</section>

<!-- ===============================
      FINAL POST-SURVEY (Anthropomorphism)
=============================== -->
<section id="postSurvey">
  <h2>Final Questionnaire</h2>
  <p>Please rate your impression of the system on the following items.</p>

  <div class="survey-block">
    <h3>1. Authenticity </h3>
    <div class="survey-options">
      <label><input type="radio" name="authenticity" value="1"> Completely fake</label>
      <label><input type="radio" name="authenticity" value="2"> Somewhat fake</label>
      <label><input type="radio" name="authenticity" value="3"> Neither fake nor natural</label>
      <label><input type="radio" name="authenticity" value="4"> Somewhat natural</label>
      <label><input type="radio" name="authenticity" value="5"> Completely natural</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>2. Humanism </h3>
    <div class="survey-options">
      <label><input type="radio" name="humanism" value="1"> Completely machine-like</label>
      <label><input type="radio" name="humanism" value="2"> Somewhat machine-like</label>
      <label><input type="radio" name="humanism" value="3"> Neither</label>
      <label><input type="radio" name="humanism" value="4"> Somewhat human-like</label>
      <label><input type="radio" name="humanism" value="5"> Completely human-like</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>3. Awareness </h3>
    <div class="survey-options">
      <label><input type="radio" name="awareness" value="1"> Completely unconscious</label>
      <label><input type="radio" name="awareness" value="2"> Somewhat unconscious</label>
      <label><input type="radio" name="awareness" value="3"> Neither</label>
      <label><input type="radio" name="awareness" value="4"> Somewhat conscious</label>
      <label><input type="radio" name="awareness" value="5"> Completely conscious</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>4. Realism </h3>
    <div class="survey-options">
      <label><input type="radio" name="realism" value="1"> Completely artificial</label>
      <label><input type="radio" name="realism" value="2"> Somewhat artificial</label>
      <label><input type="radio" name="realism" value="3"> Neither</label>
      <label><input type="radio" name="realism" value="4"> Somewhat lifelike</label>
      <label><input type="radio" name="realism" value="5"> Completely lifelike</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>5. Competence </h3>
    <div class="survey-options">
      <label><input type="radio" name="competence" value="1"> Completely incompetent</label>
      <label><input type="radio" name="competence" value="2"> Somewhat incompetent</label>
      <label><input type="radio" name="competence" value="3"> Neither</label>
      <label><input type="radio" name="competence" value="4"> Somewhat competent</label>
      <label><input type="radio" name="competence" value="5"> Completely competent</label>
    </div>
  </div>

  <button id="submitBtn">Submit</button>
</section>

<!-- ===============================
      THANK YOU
=============================== -->
<section id="thanks">
  <h2>Thank you!</h2>
</section>


<script>
  
/* ===============================
   Firebase Init 
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyBDOb-3I8TD3ZjBxtqyQNBF8YFIuIAdsKc",
  authDomain: "slm-experiment-dev.firebaseapp.com",
  projectId: "slm-experiment-dev",
  storageBucket: "slm-experiment-dev.firebasestorage.app",
  messagingSenderId: "762879513861",
  appId: "1:762879513861:web:3b67a55dc2ba727308536c",
  measurementId: "G-9WYB65Z78J"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const storage = firebase.storage();



/* ===============================
   Trial definitions (20 trials)
================================ */
const trials = [
  // Medication
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Fact",
    question: "What’s the dosage for the medication, Levaquin?"
  },
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Risk",
    question: "Does the medication Corgard have any dangerous side effects?"
  },
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Advice",
    question: "Should I take the medication Topamax if I’m already taking Tylenol?"
  },
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Estimation",
    question: "What’s the cost for the medication, Relenza?"
  },

  // Health
  {
    domain: "Health",
    context: "You’re interested in learning more about common health disorders.",
    type: "Fact",
    question: "What are symptoms of stroke?"
  },
  {
    domain: "Health",
    context: "You’re interested in learning more about common health disorders.",
    type: "Risk",
    question: "Is cancer hereditary?"
  },
  {
    domain: "Health",
    context: "You’re interested in learning more about common health disorders.",
    type: "Advice",
    question: "What should I do to reduce my risk of diabetes?"
  },
  {
    domain: "Health",
    context: "You’re interested in learning more about common health disorders.",
    type: "Estimation",
    question: "If my dad has heart disease, what are the chances I’ll get it too?"
  },

  // Career
  {
    domain: "Career",
    context: "You’re interested in a career change.",
    type: "Fact",
    question: "How commonly do people switch jobs into healthcare?"
  },
  {
    domain: "Career",
    context: "You’re interested in a career change.",
    type: "Risk",
    question: "What are the job-related health risks in finance?"
  },
  {
    domain: "Career",
    context: "You’re interested in a career change.",
    type: "Advice",
    question: "Would I earn enough as an educational administrator?"
  },
  {
    domain: "Career",
    context: "You’re interested in a career change.",
    type: "Estimation",
    question: "How many years of training would I need to do to get into computer science?"
  },

  // Travel
  {
    domain: "Travel",
    context: "You’re interested in learning more about the world.",
    type: "Fact",
    question: "Where is the world’s tallest tree?"
  },
  {
    domain: "Travel",
    context: "You’re interested in learning more about the world.",
    type: "Risk",
    question: "What are the risks in going in a cave?"
  },
  {
    domain: "Travel",
    context: "You’re interested in learning more about the world.",
    type: "Advice",
    question: "Should I visit the world’s tallest volcano on a vacation?"
  },
  {
    domain: "Travel",
    context: "You’re interested in learning more about the world.",
    type: "Estimation",
    question: "How long would it take to reach the top of the world’s tallest mountain?"
  },

  // Cooking
  {
    domain: "Cooking",
    context: "You’re interested in trying a new recipe.",
    type: "Fact",
    question: "What temperature do I need to cook chicken to?"
  },
  {
    domain: "Cooking",
    context: "You’re interested in trying a new recipe.",
    type: "Risk",
    question: "Can I drink milk that’s been expired for 2 days?"
  },
  {
    domain: "Cooking",
    context: "You’re interested in trying a new recipe.",
    type: "Advice",
    question: "If I have an allergy to peanuts, should I eat peanut oil?"
  },
  {
    domain: "Cooking",
    context: "You’re interested in trying a new recipe.",
    type: "Estimation",
    question: "How much is a dash of salt?"
  }
];

/* ===============================
   Variables + DOM Elements
================================ */
let userId = null;
let condition = null; // "natural" or "robotic"
let currentTrialIndex = 0;
let pendingTurnData = null;

const recordBtn = document.getElementById("recordBtn");
const surveyBtn = document.getElementById("surveyBtn");
const statusEl = document.getElementById("status");
const responseAudio = document.getElementById("responseAudio");
const interaction = document.getElementById("interaction");
const postSurvey = document.getElementById("postSurvey");
const trialSurvey = document.getElementById("trialSurvey");

const trialCounterEl = document.getElementById("trialCounter");
const trialContextEl = document.getElementById("trialContext");
const trialQuestionEl = document.getElementById("trialQuestion");

/* ===============================
   SCREEN LOGIC
================================ */

// Welcome → Environment
document.getElementById("welcomeContinueBtn").onclick = () => {
  document.getElementById("welcome").classList.remove("active");
  document.getElementById("environment").classList.add("active");
};

// Environment confirmation logic
const envCheckbox = document.getElementById("envConfirm");
const envContinueBtn = document.getElementById("envContinueBtn");

envCheckbox.onchange = () => {
  envContinueBtn.disabled = !envCheckbox.checked;
};


// Environment → Audio Calibration
envContinueBtn.onclick = () => {
  document.getElementById("environment").classList.remove("active");
  document.getElementById("audioCalibration").classList.add("active");
};



// After audio is heard → show per-trial survey
surveyBtn.onclick = () => {
  interaction.classList.remove("active");
  trialSurvey.classList.add("active");
};

// Audio calibration → Experiment start
document.getElementById("calibrationContinueBtn").onclick = async () => {
  const answer = document.querySelector(
    'input[name="calibrationCheck"]:checked'
  );

  if (!answer) {
    alert("Please answer the question before continuing.");
    return;
  }

  // Enforce correct answer (adjust if needed)
  if (answer.value !== "green") {
    alert("That answer is incorrect. Please listen again and try once more.");
    return;
  }

  document.getElementById("audioCalibration").classList.remove("active");

  condition = Math.random() < 0.5 ? "natural" : "robotic";
  userId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

  trials.sort(() => Math.random() - 0.5);

  await db.collection("users").doc(userId).set({
    userId,
    condition,
    createdAt: new Date(),
    audioCalibrationPassed: true,
    trialOrder: trials.map(t => ({
      domain: t.domain,
      type: t.type
    }))
  });

  currentTrialIndex = 0;
  loadTrial(currentTrialIndex);
  interaction.classList.add("active");
};


/* ===============================
   Load Trial
================================ */
function loadTrial(i) {
  const t = trials[i];
  trialCounterEl.textContent = `Trial ${i + 1} / ${trials.length}`;
  trialContextEl.textContent = t.context;
  trialQuestionEl.textContent = t.question;

  // reset audio (Safari-safe)
  responseAudio.pause();
  responseAudio.src = "";
  responseAudio.load();

  statusEl.textContent = "";
  surveyBtn.style.display = "none";
  recordBtn.disabled = false;
  recordBtn.textContent = "Ask";
  pendingTurnData = null;

  ["accuracy", "risk", "validate"].forEach(name => {
    document.querySelectorAll(`input[name="${name}"]`).forEach(r => (r.checked = false));
  });
}

/* ===============================
   Recording
================================ */
let mediaRecorder, chunks = [];

recordBtn.onclick = async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = handleRecordingStop;
    mediaRecorder.start();

    recordBtn.textContent = "Stop";
    statusEl.innerHTML = "";
  } else {
    mediaRecorder.stop();
    recordBtn.textContent = "Ask";
    statusEl.innerHTML = `<div class="dots"><span></span><span></span><span></span></div>`;
    recordBtn.disabled = true;
  }
};

/* ===============================
   HANDLE RECORDING STOP
================================ */
async function handleRecordingStop() {
  const ts = Date.now();
  const t = trials[currentTrialIndex];

  try {
    // Upload user recording (webm)
    const userBlob = new Blob(chunks, { type: "audio/webm" });
    const userRef = storage.ref(
      `users/${userId}/trial_${currentTrialIndex + 1}_${t.domain}_${t.type}_user_${ts}.webm`
    );
    await userRef.put(userBlob);
    const userAudioURL = await userRef.getDownloadURL();

    // Call backend to get model reply (.webm)
    const response = await fetch("https://callopenai-ks3vpjhzoq-uc.a.run.app", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ audio: userAudioURL, userId })
    });

    const data = await response.json();
    if (data.error) {
      statusEl.textContent = "⚠️ Error: " + data.error;
      recordBtn.disabled = false;
      return;
    }

    // Convert model .webm → WAV
    let wavLocalURL = await audioWebmToWavURL(data.audio);

    // Apply robotic DSP ONLY if needed
    if (condition === "robotic") {
      wavLocalURL = await applyRoboticEffect(wavLocalURL);
    }

    // Upload WAV to Firebase
    const wavBlob = await fetch(wavLocalURL).then(r => r.blob());
    const replyRef = storage.ref(
      `users/${userId}/trial_${currentTrialIndex + 1}_${t.domain}_${t.type}_reply_${ts}.wav`
    );
    await replyRef.put(wavBlob, { contentType: "audio/wav" });
    const wavFirebaseURL = await replyRef.getDownloadURL();

    // Save for per-trial survey
    pendingTurnData = {
      userAudioURL,
      replyAudioURL: wavFirebaseURL,
      modelText: data.text || ""
    };

    // Play WAV
    responseAudio.src = wavFirebaseURL;
    statusEl.innerHTML = "";
    surveyBtn.style.display = "inline-block";

  } catch (err) {
    console.error("Recording stop error:", err);
    statusEl.textContent = "⚠️ Error occurred. Please try again.";
  } finally {
    recordBtn.disabled = true;
  }
}

/* ===============================
   ROBOTIC DSP EFFECT
================================ */
async function applyRoboticEffect(url) {
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const decoded = await ctx.decodeAudioData(arrayBuffer);
  ctx.close();

  const offline = new OfflineAudioContext(
    decoded.numberOfChannels,
    decoded.length,
    decoded.sampleRate
  );

  const src = offline.createBufferSource();
  src.buffer = decoded;

  // Mild AM
  const osc = offline.createOscillator();
  osc.type = "sine";
  osc.frequency.value = 110;

  const modGain = offline.createGain();
  modGain.gain.value = 0.15;

  osc.connect(modGain.gain);
  src.connect(modGain);

  // Light noise
  const noiseBuffer = offline.createBuffer(1, decoded.length, decoded.sampleRate);
  const noiseData = noiseBuffer.getChannelData(0);
  for (let i = 0; i < noiseData.length; i++) {
    noiseData[i] = (Math.random() - 0.5) * 0.02;
  }

  const noise = offline.createBufferSource();
  noise.buffer = noiseBuffer;

  const noiseGain = offline.createGain();
  noiseGain.gain.value = 0.01;

  noise.connect(noiseGain);

  const mix = offline.createGain();
  modGain.connect(mix);
  noiseGain.connect(mix);
  mix.connect(offline.destination);

  osc.start(0);
  src.start(0);
  noise.start(0);

  const rendered = await offline.startRendering();
  return audioBufferToWavURL(rendered);
}

/* ===============================
   WEBM → WAV HELPER
================================ */
async function audioWebmToWavURL(webmUrl) {
  const response = await fetch(webmUrl);
  const arrayBuffer = await response.arrayBuffer();

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const decoded = await ctx.decodeAudioData(arrayBuffer);
  ctx.close();

  return audioBufferToWavURL(decoded);
}

/* ===============================
   WAV EXPORT HELPER
================================ */
function audioBufferToWavURL(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const length = buffer.length * numChannels * 2 + 44;

  const arrayBuffer = new ArrayBuffer(length);
  const view = new DataView(arrayBuffer);

  let pos = 0;
  const write = s => { for (let i = 0; i < s.length; i++) view.setUint8(pos++, s.charCodeAt(i)); };

  write("RIFF");
  view.setUint32(pos, 36 + buffer.length * numChannels * 2, true); pos += 4;
  write("WAVE");
  write("fmt ");
  view.setUint32(pos, 16, true); pos += 4;
  view.setUint16(pos, 1, true); pos += 2;
  view.setUint16(pos, numChannels, true); pos += 2;
  view.setUint32(pos, sampleRate, true); pos += 4;
  view.setUint32(pos, sampleRate * numChannels * 2, true); pos += 4;
  view.setUint16(pos, numChannels * 2, true); pos += 2;
  view.setUint16(pos, 16, true); pos += 2;
  write("data");
  view.setUint32(pos, buffer.length * numChannels * 2, true); pos += 4;

  const channels = [];
  for (let c = 0; c < numChannels; c++) {
    channels.push(buffer.getChannelData(c));
  }

  for (let i = 0; i < buffer.length; i++) {
    for (let c = 0; c < numChannels; c++) {
      let sample = channels[c][i];
      sample = Math.max(-1, Math.min(1, sample));
      view.setInt16(pos, sample * 32767, true);
      pos += 2;
    }
  }

  return URL.createObjectURL(new Blob([arrayBuffer], { type: "audio/wav" }));
}

/* ===============================
   PER-TRIAL SURVEY HANDLER
================================ */
document.getElementById("trialSurveyNextBtn").onclick = async () => {
  const acc = document.querySelector('input[name="accuracy"]:checked');
  const risk = document.querySelector('input[name="risk"]:checked');
  const val = document.querySelector('input[name="validate"]:checked');

  if (!acc || !risk || !val) {
    alert("Please answer all three questions before continuing.");
    return;
  }
  if (!pendingTurnData) {
    console.warn("No pending turn data for this trial.");
    return;
  }

  const trial = trials[currentTrialIndex];

  const docData = {
    userId,
    condition,
    trialIndex: currentTrialIndex,
    trialNumber: currentTrialIndex + 1,
    domain: trial.domain,
    context: trial.context,
    questionType: trial.type,
    questionText: trial.question,
    userAudioURL: pendingTurnData.userAudioURL,
    replyAudioURL: pendingTurnData.replyAudioURL,
    modelText: pendingTurnData.modelText,
    perceivedAccuracy: acc.value,
    perceivedRisk: risk.value,
    followupValidation: val.value,
    timestamp: new Date()
  };

  await db.collection("users").doc(userId).collection("conversation").add(docData);

  trialSurvey.classList.remove("active");

  if (currentTrialIndex < trials.length - 1) {
    currentTrialIndex++;
    loadTrial(currentTrialIndex);
    interaction.classList.add("active");
  } else {
    postSurvey.classList.add("active");
  }
};

/* ===============================
   FINAL ANTHROPOMORPHISM SURVEY
================================ */
document.getElementById("submitBtn").onclick = async () => {

  const getVal = (name) =>
    document.querySelector(`input[name="${name}"]:checked`)?.value || null;

  const authenticity = getVal("authenticity");
  const humanism = getVal("humanism");
  const awareness = getVal("awareness");
  const realism = getVal("realism");
  const competence = getVal("competence");

  if (!authenticity || !humanism || !awareness || !realism || !competence) {
    alert("Please answer all questions before submitting.");
    return;
  }

  await db.collection("users").doc(userId).set(
    {
      anthropomorphism: {
        authenticity,
        humanism,
        awareness,
        realism,
        competence,
        totalScore:
          Number(authenticity) +
          Number(humanism) +
          Number(awareness) +
          Number(realism) +
          Number(competence),
        timestamp: new Date()
      }
    },
    { merge: true }
  );

  postSurvey.classList.remove("active");
  document.getElementById("thanks").classList.add("active");
};

</script>

</body>
</html>
