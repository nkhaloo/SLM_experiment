<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Experiment</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    body { 
      font-family: system-ui, sans-serif; 
      max-width: 600px; 
      margin: 2rem auto; 
      text-align: center; 
    }
    button { 
      font-size: 1rem; 
      margin: 1rem; 
      padding: 0.6rem 1rem; 
      border-radius: 8px; 
      cursor: pointer; 
    }
    section { display:none; }
    section.active { display:block; }

    #status { font-style: italic; height: 1.5rem; }
    audio { margin-top: 1rem; width: 100%; }

    ul { text-align:left; margin:auto; max-width:450px; }

    .dots { display: inline-block; width: 3rem; text-align: center; }
    .dots span { 
      display: inline-block; 
      width: 0.5rem; 
      height: 0.5rem; 
      margin: 0 0.1rem; 
      background-color: #555; 
      border-radius: 50%; 
      animation: blink 1.4s infinite both; 
    }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink { 
      0%,80%,100%{opacity:0;} 
      40%{opacity:1;} 
    }
  </style>
</head>

<body>

<!-- ===============================
      WELCOME SCREEN
=============================== -->
<section id="welcome" class="active">
  <h2>Welcome to the experiment!</h2>
  <p>You will be interacting with a spoken language model.</p>
  <button id="welcomeContinueBtn">Continue</button>
</section>

<!-- ===============================
      INSTRUCTIONS SCREEN
=============================== -->
<section id="instructions">
  <h2>Instructions</h2>
  <p>In this experiment, you will:</p>
  <ul>
    <li>See a question on screen</li>
    <li>Press <strong>Record</strong></li>
    <li>Speak the question aloud</li>
    <li>Press <strong>Stop Recording</strong></li>
    <li>The model will give you a spoken answer</li>
    <li>Press <strong>Continue</strong> to move on</li>
  </ul>
  <button id="beginExperimentBtn">Begin</button>
</section>

<!-- ===============================
      INTERACTION
=============================== -->
<section id="interaction">
  <button id="recordBtn">üé§ Start Recording</button>
  <p id="status"></p>
  <audio id="responseAudio" controls></audio><br>
  <button id="surveyBtn" style="display:none;">Continue</button>
</section>

<!-- ===============================
      POST-SURVEY
=============================== -->
<section id="postSurvey">
  <h2>Final Questions</h2>
  <select id="satisfaction">
    <option value="">How positive was the model response?</option>
    <option value="1">1 - Very negative</option>
    <option value="2">2 - Negative</option>
    <option value="3">3 - Neutral</option>
    <option value="4">4 - Positive</option>
    <option value="5">5 - Very positive</option>
  </select><br>
  <textarea id="feedback" rows="3" placeholder="Any comments..."></textarea><br>
  <button id="submitBtn">Submit</button>
</section>

<!-- ===============================
      THANK YOU
=============================== -->
<section id="thanks">
  <h2>Thank you!</h2>
</section>


<script>
/* ===============================
   Firebase Init
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyBDOb-3I8TD3ZjBxtqyQNBF8YFIuIAdsKc",
  authDomain: "slm-experiment-dev.firebaseapp.com",
  projectId: "slm-experiment-dev",
  storageBucket: "slm-experiment-dev.firebasestorage.app",
  messagingSenderId: "762879513861",
  appId: "1:762879513861:web:3b67a55dc2ba727308536c",
  measurementId: "G-9WYB65Z78J"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* ===============================
   Variables + DOM Elements
================================ */
let userId = null;
let condition = null;

const recordBtn = document.getElementById("recordBtn");
const surveyBtn = document.getElementById("surveyBtn");
const statusEl = document.getElementById("status");
const responseAudio = document.getElementById("responseAudio");

const interaction = document.getElementById("interaction");
const postSurvey = document.getElementById("postSurvey");

/* ===============================
      SCREEN LOGIC
=============================== */

// Welcome ‚Üí Instructions
document.getElementById("welcomeContinueBtn").onclick = () => {
  document.getElementById("welcome").classList.remove("active");
  document.getElementById("instructions").classList.add("active");
};

// Instructions ‚Üí Experiment start
document.getElementById("beginExperimentBtn").onclick = async () => {
  condition = Math.random() < 0.5 ? "natural" : "robotic";
  userId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

  await db.collection("users").doc(userId).set({
    userId,
    condition,
    createdAt: new Date()
  });

  document.getElementById("instructions").classList.remove("active");
  interaction.classList.add("active");
};


/* ===============================
   Recording
================================ */
let mediaRecorder, chunks = [];

recordBtn.onclick = async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = handleRecordingStop;
    mediaRecorder.start();

    recordBtn.textContent = "‚èπ Stop Recording";
    statusEl.innerHTML = "";
  } else {
    mediaRecorder.stop();
    recordBtn.textContent = "üé§ Start Recording";
    statusEl.innerHTML = `<div class="dots"><span></span><span></span><span></span></div>`;
  }
};


/* ===============================
   HANDLE RECORDING STOP
================================ */
async function handleRecordingStop() {
  const ts = Date.now();

  // Upload user recording
  const userBlob = new Blob(chunks, { type: "audio/webm" });
  const userRef = storage.ref(`users/${userId}/user_${ts}.webm`);
  await userRef.put(userBlob);
  const userAudioURL = await userRef.getDownloadURL();

  // Call backend (.webm)
  const response = await fetch("https://callopenai-ks3vpjhzoq-uc.a.run.app", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ audio: userAudioURL, userId })
  });

  const data = await response.json();
  if (data.error) {
    statusEl.textContent = "‚ö†Ô∏è Error: " + data.error;
    return;
  }

  /* ======================================================
      Convert original TTS .webm ‚Üí WAV (both conditions)
  ====================================================== */
  let wavLocalURL = await audioWebmToWavURL(data.audio);

  /* ======================================================
      Apply robotic DSP only in robotic condition
  ====================================================== */
  if (condition === "robotic") {
    wavLocalURL = await applyRoboticEffect(wavLocalURL);
  }

  /* ======================================================
      Upload WAV to Firebase
  ====================================================== */
  const wavBlob = await fetch(wavLocalURL).then(r => r.blob());
  const replyRef = storage.ref(`users/${userId}/reply_${ts}.wav`);
  await replyRef.put(wavBlob, { contentType: "audio/wav" });
  const wavFirebaseURL = await replyRef.getDownloadURL();

  /* ======================================================
      Play WAV for participant
  ====================================================== */
  responseAudio.src = wavFirebaseURL;

  surveyBtn.style.display = "inline-block";
  statusEl.innerHTML = "";

  // Save conversation record
  await db.collection("users").doc(userId).collection("conversation").add({
    condition,
    userAudioURL,
    replyAudioURL: wavFirebaseURL,
    transcript: data.text || "",
    replyText: data.text || "",
    timestamp: new Date()
  });

  surveyBtn.onclick = () => {
    interaction.classList.remove("active");
    postSurvey.classList.add("active");
  };
}


/* ===============================
   Convert WebM ‚Üí WAV
================================ */
async function audioWebmToWavURL(webmUrl) {
  const response = await fetch(webmUrl);
  const arrayBuffer = await response.arrayBuffer();

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const decoded = await ctx.decodeAudioData(arrayBuffer);
  ctx.close();

  return audioBufferToWavURL(decoded);
}


/* ===============================
   ROBOTIC DSP EFFECT  (final kept version)
================================ */
async function applyRoboticEffect(url) {
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const decoded = await ctx.decodeAudioData(arrayBuffer);
  ctx.close();

  const offline = new OfflineAudioContext(
    decoded.numberOfChannels,
    decoded.length,
    decoded.sampleRate
  );

  const src = offline.createBufferSource();
  src.buffer = decoded;

  // Mild robotic AM
  const osc = offline.createOscillator();
  osc.type = "sine";
  osc.frequency.value = 110;

  const modGain = offline.createGain();
  modGain.gain.value = 0.15;

  osc.connect(modGain.gain);
  src.connect(modGain);

  // Light digital noise
  const noiseBuffer = offline.createBuffer(1, decoded.length, decoded.sampleRate);
  const noiseData = noiseBuffer.getChannelData(0);
  for (let i = 0; i < noiseData.length; i++) {
    noiseData[i] = (Math.random() - 0.5) * 0.02;
  }

  const noise = offline.createBufferSource();
  noise.buffer = noiseBuffer;

  const noiseGain = offline.createGain();
  noiseGain.gain.value = 0.01;

  noise.connect(noiseGain);

  // Mix
  const mix = offline.createGain();
  modGain.connect(mix);
  noiseGain.connect(mix);
  mix.connect(offline.destination);

  osc.start(0);
  src.start(0);
  noise.start(0);

  const rendered = await offline.startRendering();
  return audioBufferToWavURL(rendered);
}


/* ===============================
   WAV EXPORT HELPER
================================ */
function audioBufferToWavURL(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const length = buffer.length * numChannels * 2 + 44;

  const arrayBuffer = new ArrayBuffer(length);
  const view = new DataView(arrayBuffer);

  let pos = 0;
  const write = s => { for (let c of s) view.setUint8(pos++, c.charCodeAt(0)); };

  write("RIFF");
  view.setUint32(pos, 36 + buffer.length * numChannels * 2, true); pos += 4;
  write("WAVE");
  write("fmt ");
  view.setUint32(pos, 16, true); pos += 4;
  view.setUint16(pos, 1, true); pos += 2;
  view.setUint16(pos, numChannels, true); pos += 2;
  view.setUint32(pos, sampleRate, true); pos += 4;
  view.setUint32(pos, sampleRate * numChannels * 2, true); pos += 4;
  view.setUint16(pos, numChannels * 2, true); pos += 2;
  view.setUint16(pos, 16, true); pos += 2;
  write("data");
  view.setUint32(pos, buffer.length * numChannels * 2, true); pos += 4;

  const channels = [];
  for (let c = 0; c < numChannels; c++) channels.push(buffer.getChannelData(c));

  for (let i = 0; i < buffer.length; i++) {
    for (let c = 0; c < numChannels; c++) {
      let sample = Math.max(-1, Math.min(1, channels[c][i]));
      view.setInt16(pos, sample * 32767, true);
      pos += 2;
    }
  }

  return URL.createObjectURL(new Blob([arrayBuffer], { type: "audio/wav" }));
}


/* ===============================
   POST-SURVEY
================================ */
document.getElementById("submitBtn").onclick = async () => {
  const satisfaction = document.getElementById("satisfaction").value;
  const feedback = document.getElementById("feedback").value.trim();
  if (!satisfaction) return alert("Please rate the response.");

  await db.collection("users").doc(userId).set({
    postSurvey: { satisfaction, feedback, timestamp: new Date() }
  }, { merge: true });

  postSurvey.classList.remove("active");
  document.getElementById("thanks").classList.add("active");
};

</script>

</body>
</html>
