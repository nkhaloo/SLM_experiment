<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Experiment</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 700px;
      margin: 2rem auto;
      text-align: center;
    }
    button {
      font-size: 1rem;
      margin: 1rem;
      padding: 0.6rem 1.2rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    section { display: none; }
    section.active { display: block; }

    #status { font-style: italic; min-height: 1.5rem; }
    audio { margin-top: 1rem; width: 100%; }

    ul { text-align: left; margin: 1rem auto; max-width: 480px; }

    .dots { display: inline-block; width: 3rem; text-align: center; }
    .dots span {
      display: inline-block;
      width: 0.5rem;
      height: 0.5rem;
      margin: 0 0.1rem;
      background-color: #555;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%,80%,100% { opacity: 0; }
      40% { opacity: 1; }
    }

    .trial-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: left;
    }
    .trial-header {
      font-size: 0.9rem;
      color: #8a7a2d;
      margin-bottom: 0.5rem;
    }
    .context-label {
      margin-top: 0.25rem;
      margin-bottom: 0.75rem;
    }
    .context-label span {
      font-style: italic;
    }
    .trial-question {
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 1.5rem 0 1rem 0;
    }
    hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 0.75rem 0;
    }

    .survey-block {
      text-align: left;
      margin: 1rem auto;
      max-width: 520px;
    }
    .survey-block h3 {
      font-size: 1rem;
      margin-bottom: 0.3rem;
    }
    .survey-options {
      margin-left: 0.75rem;
    }
    .survey-options label {
      display: block;
      margin: 0.15rem 0;
    }
  </style>
</head>

<body>

<!-- ===============================
      WELCOME SCREEN
=============================== -->
<section id="welcome" class="active">
  <h2>Welcome to the experiment!</h2>
  <p>You will be interacting with a spoken language model.</p>
  <button id="welcomeContinueBtn">Continue</button>
</section>

<!-- ===============================
      INSTRUCTIONS SCREEN
=============================== -->
<section id="instructions">
  <h2>Instructions</h2>
  <p>In this experiment, you will:</p>
  <ul>
    <li>See a question and a brief context on screen</li>
    <li>Press <strong>Ask</strong> to start recording</li>
    <li>Read the question aloud</li>
    <li>Press <strong>Stop</strong> to finish recording</li>
    <li>Listen to the model’s spoken answer</li>
    <li>Answer three quick questions about the answer</li>
  </ul>
  <p>You will complete all questions.</p>
  <button id="beginExperimentBtn">Begin</button>
</section>

<!-- ===============================
      TRIAL INTERACTION
=============================== -->
<section id="interaction">
  <div class="trial-card">
    <div class="trial-header" id="trialCounter">Trial 1 / 20</div>
    <div class="context-label">
      <strong>Context:</strong>
      <span id="trialContext"></span>
    </div>
    <hr />
    <div class="trial-question" id="trialQuestion"></div>

    <div style="text-align:center; margin-top:1rem;">
      <button id="recordBtn">Ask</button>
      <p id="status"></p>
      <audio id="responseAudio" controls></audio><br />
      <button id="surveyBtn" style="display:none;">Continue</button>
    </div>
  </div>
</section>

<!-- ===============================
      PER-TRIAL SURVEY
=============================== -->
<section id="trialSurvey">
  <h2>Trial Feedback</h2>

  <div class="survey-block">
    <h3>1. How accurate is the system’s response?</h3>
    <div class="survey-options">
      <label><input type="radio" name="accuracy" value="1" /> Not at all accurate</label>
      <label><input type="radio" name="accuracy" value="2" /> Somewhat accurate</label>
      <label><input type="radio" name="accuracy" value="3" /> Mostly accurate</label>
      <label><input type="radio" name="accuracy" value="4" /> Completely accurate</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>2. If you were relying on this information, how risky would it be if the system got this information wrong?</h3>
    <div class="survey-options">
      <label><input type="radio" name="risk" value="1" /> Not at all risky</label>
      <label><input type="radio" name="risk" value="2" /> Neither risky nor unrisky</label>
      <label><input type="radio" name="risk" value="3" /> Somewhat risky</label>
      <label><input type="radio" name="risk" value="4" /> Extremely risky</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>3. Would you validate the system’s answer with other sources?</h3>
    <div class="survey-options">
      <label><input type="radio" name="validate" value="0" /> No</label>
      <label><input type="radio" name="validate" value="1" /> Maybe</label>
      <label><input type="radio" name="validate" value="2" /> Yes</label>
    </div>
  </div>

  <button id="trialSurveyNextBtn">Next</button>
</section>

<!-- ===============================
      FINAL POST-SURVEY
=============================== -->
<section id="postSurvey">
  <h2>Final Questions</h2>
  <select id="satisfaction">
    <option value="">How positive was the model response overall?</option>
    <option value="1">1 - Very negative</option>
    <option value="2">2 - Negative</option>
    <option value="3">3 - Neutral</option>
    <option value="4">4 - Positive</option>
    <option value="5">5 - Very positive</option>
  </select><br>
  <textarea id="feedback" rows="3" style="width:90%;" placeholder="Any comments..."></textarea><br>
  <button id="submitBtn">Submit</button>
</section>

<!-- ===============================
      THANK YOU
=============================== -->
<section id="thanks">
  <h2>Thank you!</h2>
</section>


<script>
/* ===============================
   Firebase Init
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyBDOb-3I8TD3ZjBxtqyQNBF8YFIuIAdsKc",
  authDomain: "slm-experiment-dev.firebaseapp.com",
  projectId: "slm-experiment-dev",
  storageBucket: "slm-experiment-dev.firebasestorage.app",
  messagingSenderId: "762879513861",
  appId: "1:762879513861:web:3b67a55dc2ba727308536c",
  measurementId: "G-9WYB65Z78J"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* ===============================
   Trial definitions (20 trials)
================================ */
const trials = [
  // Medication
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Fact",
    question: "What’s the dosage for the medication, Levaquin?"
  },
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Risk",
    question: "Does the medication Corgard have any dangerous side effects?"
  },
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Advice",
    question: "Should I take the medication Topamax if I’m already taking Tylenol?"
  },
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Estimation",
    question: "What’s the cost for the medication, Relenza?"
  },

  // Health
  {
    domain: "Health",
    context: "You’re interested in learning more about common health disorders.",
    type: "Fact",
    question: "What are symptoms of stroke?"
  },
  {
    domain: "Health",
    context: "You’re interested in learning more about common health disorders.",
    type: "Risk",
    question: "Is cancer hereditary?"
  },
  {
    domain: "Health",
    context: "You’re interested in learning more about common health disorders.",
    type: "Advice",
    question: "What should I do to reduce my risk of diabetes?"
  },
  {
    domain: "Health",
    context: "You’re interested in learning more about common health disorders.",
    type: "Estimation",
    question: "If my dad has heart disease, what are the chances I’ll get it too?"
  },

  // Career
  {
    domain: "Career",
    context: "You’re interested in a career change.",
    type: "Fact",
    question: "How commonly do people switch jobs into healthcare?"
  },
  {
    domain: "Career",
    context: "You’re interested in a career change.",
    type: "Risk",
    question: "What are the job-related health risks in finance?"
  },
  {
    domain: "Career",
    context: "You’re interested in a career change.",
    type: "Advice",
    question: "Would I earn enough as an educational administrator?"
  },
  {
    domain: "Career",
    context: "You’re interested in a career change.",
    type: "Estimation",
    question: "How many years of training would I need to do to get into computer science?"
  },

  // Travel
  {
    domain: "Travel",
    context: "You’re interested in learning more about the world.",
    type: "Fact",
    question: "Where is the world’s tallest tree?"
  },
  {
    domain: "Travel",
    context: "You’re interested in learning more about the world.",
    type: "Risk",
    question: "What are the risks in going in a cave?"
  },
  {
    domain: "Travel",
    context: "You’re interested in learning more about the world.",
    type: "Advice",
    question: "Should I visit the world’s tallest volcano on a vacation?"
  },
  {
    domain: "Travel",
    context: "You’re interested in learning more about the world.",
    type: "Estimation",
    question: "How long would it take to reach the top of the world’s tallest mountain?"
  },

  // Cooking
  {
    domain: "Cooking",
    context: "You’re interested in trying a new recipe.",
    type: "Fact",
    question: "What temperature do I need to cook chicken to?"
  },
  {
    domain: "Cooking",
    context: "You’re interested in trying a new recipe.",
    type: "Risk",
    question: "Can I drink milk that’s been expired for 2 days?"
  },
  {
    domain: "Cooking",
    context: "You’re interested in trying a new recipe.",
    type: "Advice",
    question: "If I have an allergy to peanuts, should I eat peanut oil?"
  },
  {
    domain: "Cooking",
    context: "You’re interested in trying a new recipe.",
    type: "Estimation",
    question: "How much is a dash of salt?"
  }
];

/* ===============================
   Variables + DOM Elements
================================ */
let userId = null;
let condition = null; // "natural" or "robotic"
let currentTrialIndex = 0;
let pendingTurnData = null; // holds audio + model text for current trial

const recordBtn = document.getElementById("recordBtn");
const surveyBtn = document.getElementById("surveyBtn");
const statusEl = document.getElementById("status");
const responseAudio = document.getElementById("responseAudio");
const interaction = document.getElementById("interaction");
const postSurvey = document.getElementById("postSurvey");
const trialSurvey = document.getElementById("trialSurvey");

const trialCounterEl = document.getElementById("trialCounter");
const trialContextEl = document.getElementById("trialContext");
const trialQuestionEl = document.getElementById("trialQuestion");

/* ===============================
      SCREEN LOGIC
=============================== */

// Welcome → Instructions
document.getElementById("welcomeContinueBtn").onclick = () => {
  document.getElementById("welcome").classList.remove("active");
  document.getElementById("instructions").classList.add("active");
};

// Instructions → Experiment start
document.getElementById("beginExperimentBtn").onclick = async () => {
  condition = Math.random() < 0.5 ? "natural" : "robotic";
  userId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

  await db.collection("users").doc(userId).set({
    userId,
    condition,
    createdAt: new Date()
  });

  currentTrialIndex = 0;
  loadTrial(currentTrialIndex);

  document.getElementById("instructions").classList.remove("active");
  interaction.classList.add("active");
};

/* ===============================
   Load Trial
================================ */
function loadTrial(i) {
  const t = trials[i];
  trialCounterEl.textContent = `Trial ${i + 1} / ${trials.length}`;
  trialContextEl.textContent = t.context;
  trialQuestionEl.textContent = t.question;

  // reset UI state
  responseAudio.src = "";
  statusEl.textContent = "";
  surveyBtn.style.display = "none";
  recordBtn.disabled = false;
  pendingTurnData = null;

  // clear per-trial survey radios
  ["accuracy", "risk", "validate"].forEach(name => {
    document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.checked = false);
  });
}

/* ===============================
   Recording
================================ */
let mediaRecorder, chunks = [];

recordBtn.onclick = async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = handleRecordingStop;
    mediaRecorder.start();

    recordBtn.textContent = "Stop";
    statusEl.innerHTML = "";
  } else {
    mediaRecorder.stop();
    recordBtn.textContent = "Ask";
    statusEl.innerHTML = `<div class="dots"><span></span><span></span><span></span></div>`;
    recordBtn.disabled = true; // prevent double recordings while processing
  }
};

/* ===============================
   HANDLE RECORDING STOP (FIXED)
================================ */
async function handleRecordingStop() {
  const ts = Date.now();
  const trial = trials[currentTrialIndex]; // use only once

  try {
    /* 1. Upload user audio (webm) */
    const userBlob = new Blob(chunks, { type: "audio/webm" });

    const userRef = storage.ref(
      `users/${userId}/trial_${currentTrialIndex + 1}_${trial.domain}_${trial.type}_user_${ts}.webm`
    );

    await userRef.put(userBlob);
    const userAudioURL = await userRef.getDownloadURL();


    /* 2. Call backend → returns TTS .webm */
    const response = await fetch("https://callopenai-ks3vpjhzoq-uc.a.run.app", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ audio: userAudioURL, userId })
    });

    const data = await response.json();
    if (data.error) {
      statusEl.textContent = "⚠️ Error: " + data.error;
      recordBtn.disabled = false;
      return;
    }


    /* 3. Convert model .webm → WAV */
    let wavLocalURL = await audioWebmToWavURL(data.audio);

    /* 4. Apply robotic filtering */
    if (condition === "robotic") {
      wavLocalURL = await applyRoboticEffect(wavLocalURL);
    }

    /* 5. Upload WAV reply (this is the only saved model audio) */
    const wavBlob = await fetch(wavLocalURL).then(r => r.blob());

    const replyRef = storage.ref(
      `users/${userId}/trial_${currentTrialIndex + 1}_${trial.domain}_${trial.type}_reply_${ts}.wav`
    );

    await replyRef.put(wavBlob, { contentType: "audio/wav" });
    const wavFirebaseURL = await replyRef.getDownloadURL();


    /* 6. Play result */
    responseAudio.src = wavFirebaseURL;
    statusEl.innerHTML = "";
    surveyBtn.style.display = "inline-block";


    /* 7. Store pending data (saved after per-trial survey) */
    pendingTurnData = {
      userAudioURL,
      replyAudioURL: wavFirebaseURL,
      modelText: data.text || "",
      domain: trial.domain,
      type: trial.type,
      question: trial.question
    };

  } catch (err) {
    console.error(err);
    statusEl.textContent = "⚠️ Error occurred. Please try again.";
  } finally {
    recordBtn.disabled = true;
  }
}

/* After audio → per-trial survey */
surveyBtn.onclick = () => {
  interaction.classList.remove("active");
  trialSurvey.classList.add("active");
};



/* ===============================
   Convert WebM → WAV
================================ */
async function audioWebmToWavURL(webmUrl) {
  const response = await fetch(webmUrl);
  const arrayBuffer = await response.arrayBuffer();

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const decoded = await ctx.decodeAudioData(arrayBuffer);
  ctx.close();

  return audioBufferToWavURL(decoded);
}


/* ===============================
   ROBOTIC DSP EFFECT
   (mild AM + light noise)
================================ */
async function applyRoboticEffect(url) {
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const decoded = await ctx.decodeAudioData(arrayBuffer);
  ctx.close();

  const offline = new OfflineAudioContext(
    decoded.numberOfChannels,
    decoded.length,
    decoded.sampleRate
  );

  const src = offline.createBufferSource();
  src.buffer = decoded;

  // Mild AM for robotic monotone
  const osc = offline.createOscillator();
  osc.type = "sine";
  osc.frequency.value = 110; // "robotic" pitch

  const modGain = offline.createGain();
  modGain.gain.value = 0.15;

  osc.connect(modGain.gain);
  src.connect(modGain);

  // Light digital noise
  const noiseBuffer = offline.createBuffer(1, decoded.length, decoded.sampleRate);
  const noiseData = noiseBuffer.getChannelData(0);
  for (let i = 0; i < noiseData.length; i++) {
    noiseData[i] = (Math.random() - 0.5) * 0.02;
  }

  const noise = offline.createBufferSource();
  noise.buffer = noiseBuffer;

  const noiseGain = offline.createGain();
  noiseGain.gain.value = 0.01;

  noise.connect(noiseGain);

  // Mix
  const mix = offline.createGain();
  modGain.connect(mix);
  noiseGain.connect(mix);
  mix.connect(offline.destination);

  osc.start(0);
  src.start(0);
  noise.start(0);

  const rendered = await offline.startRendering();
  return audioBufferToWavURL(rendered);
}


/* ===============================
   WAV EXPORT HELPER
================================ */
function audioBufferToWavURL(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const length = buffer.length * numChannels * 2 + 44;

  const arrayBuffer = new ArrayBuffer(length);
  const view = new DataView(arrayBuffer);

  let pos = 0;
  const write = s => { for (let c of s) view.setUint8(pos++, c.charCodeAt(0)); };

  write("RIFF");
  view.setUint32(pos, 36 + buffer.length * numChannels * 2, true); pos += 4;
  write("WAVE");
  write("fmt ");
  view.setUint32(pos, 16, true); pos += 4;
  view.setUint16(pos, 1, true); pos += 2;
  view.setUint16(pos, numChannels, true); pos += 2;
  view.setUint32(pos, sampleRate, true); pos += 4;
  view.setUint32(pos, sampleRate * numChannels * 2, true); pos += 4;
  view.setUint16(pos, numChannels * 2, true); pos += 2;
  view.setUint16(pos, 16, true); pos += 2;
  write("data");
  view.setUint32(pos, buffer.length * numChannels * 2, true); pos += 4;

  const channels = [];
  for (let c = 0; c < numChannels; c++) channels.push(buffer.getChannelData(c));

  for (let i = 0; i < buffer.length; i++) {
    for (let c = 0; c < numChannels; c++) {
      let sample = Math.max(-1, Math.min(1, channels[c][i]));
      view.setInt16(pos, sample * 32767, true);
      pos += 2;
    }
  }

  return URL.createObjectURL(new Blob([arrayBuffer], { type: "audio/wav" }));
}


/* ===============================
   PER-TRIAL SURVEY HANDLER
================================ */
document.getElementById("trialSurveyNextBtn").onclick = async () => {
  const acc = document.querySelector('input[name="accuracy"]:checked');
  const risk = document.querySelector('input[name="risk"]:checked');
  const val = document.querySelector('input[name="validate"]:checked');

  if (!acc || !risk || !val) {
    alert("Please answer all three questions before continuing.");
    return;
  }
  if (!pendingTurnData) {
    console.warn("No pending turn data for this trial.");
    return;
  }

  const trial = trials[currentTrialIndex];

  // Build document to store
  const docData = {
    userId,
    condition,
    trialIndex: currentTrialIndex,
    trialNumber: currentTrialIndex + 1,
    domain: trial.domain,
    context: trial.context,
    questionType: trial.type,
    questionText: trial.question,
    userAudioURL: pendingTurnData.userAudioURL,
    replyAudioURL: pendingTurnData.replyAudioURL,
    modelText: pendingTurnData.modelText,
    perceivedAccuracy: acc.value,
    perceivedRisk: risk.value,
    followupValidation: val.value,
    timestamp: new Date()
  };

  await db.collection("users").doc(userId).collection("conversation").add(docData);

  // move to next trial or final survey
  trialSurvey.classList.remove("active");

  if (currentTrialIndex < trials.length - 1) {
    currentTrialIndex++;
    loadTrial(currentTrialIndex);
    interaction.classList.add("active");
  } else {
    postSurvey.classList.add("active");
  }
};


/* ===============================
   FINAL POST-SURVEY
================================ */
document.getElementById("submitBtn").onclick = async () => {
  const satisfaction = document.getElementById("satisfaction").value;
  const feedback = document.getElementById("feedback").value.trim();
  if (!satisfaction) return alert("Please answer the final satisfaction question.");

  await db.collection("users").doc(userId).set({
    postSurvey: { satisfaction, feedback, timestamp: new Date() }
  }, { merge: true });

  postSurvey.classList.remove("active");
  document.getElementById("thanks").classList.add("active");
};
</script>

</body>
</html>
