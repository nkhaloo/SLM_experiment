<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Experiment</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>



  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 1000px;
      margin: 2rem auto;
      text-align: center;
    }
    button {
      font-size: 1rem;
      margin: 1rem;
      padding: 0.6rem 1.2rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    /* Center specific continue buttons under their content */
    #micAcceptContinueBtn,
    #micPreviewContinueBtn {
      display: block;
      margin: 1rem auto;
    }
    section { display: none; }
    section.active { display: block; }

    #status { font-style: italic; min-height: 1.5rem; }
    audio { margin-top: 1rem; width: 100%; }
    .locked-audio { pointer-events: none; display: none; }

    ul { text-align: left; margin: 1rem auto; max-width: 480px; }

    .dots { display: inline-block; width: 3rem; text-align: center; }
    .dots span {
      display: inline-block;
      width: 0.5rem;
      height: 0.5rem;
      margin: 0 0.1rem;
      background-color: #555;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%,80%,100% { opacity: 0; }
      40% { opacity: 1; }
    }

    .trial-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: left;
    }
    .trial-header {
      font-size: 0.9rem;
      color: #8a7a2d;
      margin-bottom: 0.5rem;
    }
    .context-label {
      margin-top: 0.25rem;
      margin-bottom: 0.75rem;
    }
    .context-label span {
      font-style: italic;
    }
    .trial-question {
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 1.5rem 0 1rem 0;
    }
    hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 0.75rem 0;
    }

    .survey-block {
      text-align: left;
      margin: 2rem auto;
      max-width: 520px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
    }
    .impressions .survey-block {
      max-width: 900px;
    }
    .survey-block h3 {
      font-size: 0.8rem;
      margin-bottom: 0.3rem;
    }
    .survey-options {
      margin-left: 0.75rem;
    }
    .survey-options label {
      display: block;
      margin: 0.15rem 0;
    }
    .survey-options.horizontal {
      display: flex;
      flex-wrap: nowrap;
      justify-content: center;
    }
    .survey-options.horizontal label {
      display: inline-block;
      margin: 0 1rem 0.15rem 0;
      white-space: nowrap;
    }
    .impressions .survey-options.horizontal label {
      font-size: 0.75rem;
      margin: 0 0.5rem 0.15rem 0;
    }
    .survey-block label {
  display: block;
  margin: 0.25rem 0;
}

  </style>
</head>

<body>

<!-- ===============================
      WELCOME SCREEN (Slide 1)
=============================== -->
<section id="welcome" class="active">
  <h2>Welcome!</h2>

  <p>
    In today‚Äôs study, you will interact with a chat system.
  </p>

  <p>
    The system you will be interacting with for this experiment can answer questions about work, health, and general facts.
  </p>
    For this study, you will need to be able to see the full screen and listen to audio.
  </strong></p>

  <button id="welcomeContinueBtn">Continue</button>
</section>


<!-- ===============================
      ENVIRONMENT SETUP (Slide 2)
=============================== -->
<section id="environment">
  <h2>Before We Begin</h2>

  <p>Before we begin, you‚Äôll need to set up your environment.</p>

  <ul>
    <li>Quiet room</li>
    <li>No background noise (e.g., dog barking, other people talking, TV on)</li>
    <li>Silence notifications on your computer and phone</li>
  </ul>

  <p><strong>
    Below, click to confirm you have met these environment requirements:
  </strong></p>

  <label style="display:block; text-align:left; max-width:500px; margin:1rem auto;">
    <input type="checkbox" id="envConfirm" />
    I confirm I‚Äôm in a quiet room with no background noise and I‚Äôve silenced
    notifications on my computer and phone
  </label>

  <button id="envContinueBtn" disabled>Continue</button>
</section>





<!-- ===============================
      TRIAL INTERACTION
=============================== -->
<section id="interaction">
  <p style="text-align: center; margin-bottom: 1rem; font-size: 1.1rem;">
    <strong>Press the "Record" button below to record yourself asking the question out loud.</strong>
  </p>

  <div class="trial-card">
    <div class="trial-header" id="trialCounter">Trial 1 / 20</div>
    <div class="context-label">
      <strong>Context:</strong>
      <span id="trialContext"></span>
    </div>
    <hr />
    <div class="trial-question" id="trialQuestion"></div>

    <div style="text-align:center; margin-top:1rem;">
      <button id="recordBtn">Record</button>
      <button id="skipTrialBtn" style="background: #dc2626; color: white;">Skip Trial</button>
      <p id="status"></p>
      <div id="audioVisualization" style="display: none; margin: 1rem 0;">
        <span style="font-size: 2rem;">üó£Ô∏è</span>
        <div style="margin-top: 0.5rem; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
          <div id="waveform" style="height: 100%; background: #2563eb; width: 0%; transition: width 0.1s;"></div>
        </div>
      </div>
      <audio
        id="responseAudio"
        class="locked-audio"
        controlsList="nodownload noplaybackrate"
        disableRemotePlayback
      ></audio>
      <button id="surveyBtn" style="display:none;">Continue</button>
    </div>
  </div>
</section>


<!-- ===============================
      AUDIO CALIBRATION
=============================== -->
<section id="audioCalibration">
  <h2>Audio Calibration</h2>

  <p>
    Play the audio below. You can adjust the volume on your device until it is at a
    comfortable listening level.
  </p>

  <p><strong>
    Important! Please keep the level the same throughout the experiment.
  </strong></p>

  <audio id="calibrationAudio" controls controlsList="nodownload noplaybackrate" disableRemotePlayback preload="auto">
    <source src="attention_check/audio_check.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <p style="margin-top:1.5rem;">
    After listening, please answer the question below.
  </p>

  <div class="survey-block">
    <h3>What color was mentioned in the recording?</h3>
    <div class="survey-options">
      <label><input type="radio" name="calibrationCheck" value="yellow"> Yellow</label>
      <label><input type="radio" name="calibrationCheck" value="green"> Green</label>
      <label><input type="radio" name="calibrationCheck" value="red"> Red</label>
    </div>
  </div>

  <button id="calibrationContinueBtn">Continue</button>
</section>

<!-- ===============================
      MICROPHONE PREVIEW
=============================== -->
<section id="micPreview">
  <h2>Microphone Permission</h2>

  <p>
    During the experiment, you will need to grant microphone access to record your voice.
  </p>

  <p>
    You will see a dialog like this and have to accept it:
  </p>

  <img src="microphone_accept/mic.png" alt="Microphone permission dialog" style="max-width: 300px; height: auto; border: 1px solid #ddd; margin: 1rem 0;" />

  <button id="micPreviewContinueBtn">Continue</button>
</section>

<!-- ===============================
      MICROPHONE ACCEPT
=============================== -->
<section id="micAccept">
  <h2>Microphone Permission</h2>

  <p>
    Please click "Continue" below to grant microphone access.
  </p>

  <p id="micAcceptStatus"></p>

  <div style="text-align: center;">
    <button id="micAcceptContinueBtn">Continue</button>
  </div>
</section>

<!-- ===============================
      MICROPHONE TEST
=============================== -->
<section id="micTest">
  <h2>Microphone Test</h2>

  <p>
    Let's test your microphone to make sure it's working properly.
  </p>

  <p><strong>
    Click "Record" and say a few words, then click "Stop" to hear your recording played back.
  </strong></p>

  <div style="text-align:center; margin: 2rem 0;">
    <button id="micTestRecordBtn">Record</button>
    <p id="micTestStatus"></p>
    <audio id="micTestPlayback" controls controlsList="nodownload noplaybackrate" style="margin-top: 1rem;"></audio>
    <button id="micTestContinueBtn" style="display: none; margin-top: 1rem;">Continue</button>
  </div>
</section>

<!-- ===============================
      TASK INSTRUCTIONS (NEW)
=============================== -->
<section id="taskInstructions">
  <h2>Instructions</h2>

  <p>
    The system can answer questions about work, health, and general facts.
  </p>

  <p>
      On each trial, you will be presented with a question (e.g., ‚ÄúHow far away is the moon?‚Äù) that you must verbally ask the system. You will click the 'Ask' button, ask the question, and press 'Stop' when done. The system will then provide a verbal response.
    </p>
  </p>

  <p><strong>Your task will be to rate the system's response:</strong></p>

  <ul>
    <li>How accurate is the system's response?</li>
    <li>
      If you were relying on this information, how risky would it be if the system
      got this information wrong?
    </li>
    <li>Would you validate the system's answer with other sources?</li>
  </ul>

  <p><strong>There are no right or wrong answers.</strong></p>

  <button id="taskInstructionsContinueBtn">Continue</button>
</section>

<!-- ===============================
      TEST TRIAL
=============================== -->
<section id="testTrial">
  <h2>Practice Trial</h2>

  <p style="text-align: center; margin-bottom: 1rem;">
    Let's do a quick practice trial to make sure everything is working. Press the "Record" button below to record yourself asking the question out loud.
  </p>

  <div class="trial-card">
    <div class="trial-header">Practice Trial</div>
    <div class="context-label">
      <strong>Context:</strong>
      <span>This is a practice question to test your audio setup.</span>
    </div>
    <hr />
    <div class="trial-question">What is the capital of France?</div>

    <div style="text-align:center; margin-top:1rem;">
      <button id="testRecordBtn">Record</button>
      <p id="testStatus"></p>
      <div id="testAudioVisualization" style="display: none; margin: 1rem 0;">
        <span style="font-size: 2rem;">üó£Ô∏è</span>
        <div style="margin-top: 0.5rem; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
          <div id="testWaveform" style="height: 100%; background: #2563eb; width: 0%; transition: width 0.1s;"></div>
        </div>
      </div>
      <audio
        id="testResponseAudio"
        class="locked-audio"
        controlsList="nodownload noplaybackrate"
        disableRemotePlayback
      ></audio>
      <button id="testContinueBtn" style="display:none;">Continue to Experiment</button>
    </div>
  </div>
</section>

<!-- ===============================
      READ ALOUD 
=============================== -->
<section id="readAloud">
  <h2>Before We Begin</h2>

  <p>
    Before starting the task, please complete the short speaking exercise below.
  </p>

  <p><strong>
    Important:
  </strong></p>

  <ul>
    <li>Please press <strong>Record</strong> and read the passage aloud.</li>
    <li>This recording will <strong>not</strong> receive a response.</li>
    <li>The AI system will <strong>not</strong> see or respond to what you say.</li>
    <li>This step is only to ensure your microphone is working properly.</li>
  </ul>

  <div class="trial-card" style="margin-top:1.5rem;">
    <p style="font-size:0.95rem; line-height:1.4;">
      <strong>The Rainbow Passage</strong><br /><br />
      When the sunlight strikes raindrops in the air, they act like a prism and form a rainbow. The rainbow is a division of white light into many beautiful colors. These take the shape of a long round arch, with its path high above, and its two ends apparently beyond the horizon. There is, according to legend, a boiling pot of gold at one end. People look but no one ever finds it. When a man looks for something beyond his reach, his friends say he is looking for the pot of gold at the end of the rainbow.
    </p>
  </div>

  <div style="margin-top:1.5rem;">
    <button id="readAloudRecordBtn">Record</button>
    <p id="readAloudStatus"></p>
    <button id="readAloudContinueBtn" disabled>Continue</button>
  </div>
</section>



<!-- ===============================
      PER-TRIAL SURVEY
=============================== -->
<section id="trialSurvey">
  <h2>Trial Feedback</h2>

  <div class="survey-block">
    <h3>1. How accurate is the system‚Äôs response?</h3>
    <div class="survey-options">
      <label><input type="radio" name="accuracy" value="1" /> Not at all accurate</label>
      <label><input type="radio" name="accuracy" value="2" /> Somewhat accurate</label>
      <label><input type="radio" name="accuracy" value="3" /> Mostly accurate</label>
      <label><input type="radio" name="accuracy" value="4" /> Completely accurate</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>2. If you were relying on this information, how risky would it be if the system got this information wrong?</h3>
    <div class="survey-options">
      <label><input type="radio" name="risk" value="1" /> Not at all risky</label>
      <label><input type="radio" name="risk" value="2" /> Neither risky nor unrisky</label>
      <label><input type="radio" name="risk" value="3" /> Somewhat risky</label>
      <label><input type="radio" name="risk" value="4" /> Extremely risky</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>3. Would you validate the system‚Äôs answer with other sources?</h3>
    <div class="survey-options">
      <label><input type="radio" name="validate" value="0" /> No</label>
      <label><input type="radio" name="validate" value="1" /> Maybe</label>
      <label><input type="radio" name="validate" value="2" /> Yes</label>
    </div>
  </div>

  <button id="trialSurveyNextBtn">Next</button>
</section>

<!-- ===============================
      SYSTEM IMPRESSIONS
=============================== -->
<section id="systemImpression" class="impressions">
  <h2>System Impressions part 1</h2>

  <p>
    Now, we want you to answer some questions about the system that you just interacted with.
  </p>

  <div class="survey-block">
    <h3>The system was knowledgeable about my questions.</h3>
    <div class="survey-options horizontal">
      <label><input type="radio" name="knowledgeable" value="1"> True</label>
      <label><input type="radio" name="knowledgeable" value="0"> False</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>The system's responses to my questions were in my best interest.</h3>
    <div class="survey-options horizontal">
      <label><input type="radio" name="bestInterest" value="1"> True</label>
      <label><input type="radio" name="bestInterest" value="0"> False</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>I believe the system's responses to me were honest.</h3>
    <div class="survey-options horizontal">
      <label><input type="radio" name="honest" value="1"> True</label>
      <label><input type="radio" name="honest" value="0"> False</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>I believe the system's responses to me were unbiased.</h3>
    <div class="survey-options horizontal">
      <label><input type="radio" name="unbiased" value="1"> True</label>
      <label><input type="radio" name="unbiased" value="0"> False</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>Please rate your impression of the system:</h3>
    <p><em>Untrustworthy ~ Trustworthy</em></p>
    <div class="survey-options horizontal">
      <label><input type="radio" name="trustworthiness" value="1"> Extremely untrustworthy</label>
      <label><input type="radio" name="trustworthiness" value="2"> Somewhat untrustworthy</label>
      <label><input type="radio" name="trustworthiness" value="3"> Neither untrustworthy nor trustworthy</label>
      <label><input type="radio" name="trustworthiness" value="4"> Somewhat trustworthy</label>
      <label><input type="radio" name="trustworthiness" value="5"> Extremely trustworthy</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>Please rate your impression of the system:</h3>
    <p><em>Tool ~ Collaborator</em></p>
    <div class="survey-options horizontal">
      <label><input type="radio" name="collaborator" value="1"> Extremely like a tool</label>
      <label><input type="radio" name="collaborator" value="2"> Somewhat like a tool</label>
      <label><input type="radio" name="collaborator" value="3"> Neither a tool nor a collaborator</label>
      <label><input type="radio" name="collaborator" value="4"> Somewhat like a collaborator</label>
      <label><input type="radio" name="collaborator" value="5"> Extremely like a collaborator</label>
    </div>
  </div>

  <button id="systemImpressionContinueBtn">Continue</button>
</section>



<!-- ===============================
      FINAL POST-SURVEY (Anthropomorphism)
=============================== -->
<section id="postSurvey" class="impressions">
  <h2>System Impressions part 2</h2>
  <p>Please rate your impression of the system on the following items.</p>

  <div class="survey-block">
    <h3>1. Authenticity </h3>
    <div class="survey-options horizontal">
      <label><input type="radio" name="authenticity" value="1"> Completely fake</label>
      <label><input type="radio" name="authenticity" value="2"> Somewhat fake</label>
      <label><input type="radio" name="authenticity" value="3"> Neither fake nor natural</label>
      <label><input type="radio" name="authenticity" value="4"> Somewhat natural</label>
      <label><input type="radio" name="authenticity" value="5"> Completely natural</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>2. Humanism </h3>
    <div class="survey-options horizontal">
      <label><input type="radio" name="humanism" value="1"> Completely machine-like</label>
      <label><input type="radio" name="humanism" value="2"> Somewhat machine-like</label>
      <label><input type="radio" name="humanism" value="3"> Neither</label>
      <label><input type="radio" name="humanism" value="4"> Somewhat human-like</label>
      <label><input type="radio" name="humanism" value="5"> Completely human-like</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>3. Awareness </h3>
    <div class="survey-options horizontal">
      <label><input type="radio" name="awareness" value="1"> Completely unconscious</label>
      <label><input type="radio" name="awareness" value="2"> Somewhat unconscious</label>
      <label><input type="radio" name="awareness" value="3"> Neither</label>
      <label><input type="radio" name="awareness" value="4"> Somewhat conscious</label>
      <label><input type="radio" name="awareness" value="5"> Completely conscious</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>4. Realism </h3>
    <div class="survey-options horizontal">
      <label><input type="radio" name="realism" value="1"> Completely artificial</label>
      <label><input type="radio" name="realism" value="2"> Somewhat artificial</label>
      <label><input type="radio" name="realism" value="3"> Neither</label>
      <label><input type="radio" name="realism" value="4"> Somewhat lifelike</label>
      <label><input type="radio" name="realism" value="5"> Completely lifelike</label>
    </div>
  </div>

  <div class="survey-block">
    <h3>5. Competence </h3>
    <div class="survey-options horizontal">
      <label><input type="radio" name="competence" value="1"> Completely incompetent</label>
      <label><input type="radio" name="competence" value="2"> Somewhat incompetent</label>
      <label><input type="radio" name="competence" value="3"> Neither</label>
      <label><input type="radio" name="competence" value="4"> Somewhat competent</label>
      <label><input type="radio" name="competence" value="5"> Completely competent</label>
    </div>
  </div>

  <button id="submitBtn">Continue</button>
</section>


<!-- ===============================
      DEMOGRAPHICS
=============================== -->
<section id="demographics">
  <p>Now please answer these questions about yourself.</p>

  <div class="survey-block">
    <h3>Please select your age range.</h3>
    <label><input type="radio" name="age" value="18‚Äì24"> 18‚Äì24</label>
    <label><input type="radio" name="age" value="25‚Äì34"> 25‚Äì34</label>
    <label><input type="radio" name="age" value="35‚Äì44"> 35‚Äì44</label>
    <label><input type="radio" name="age" value="45‚Äì54"> 45‚Äì54</label>
    <label><input type="radio" name="age" value="55+"> 55+</label>
  </div>

  <div class="survey-block">
    <h3>Which race/ethnicity do you most strongly identify with?</h3>
    <label><input type="checkbox" name="ethnicity" value="Asian American"> Asian American</label>
    <label><input type="checkbox" name="ethnicity" value="Black American"> Black American</label>
    <label><input type="checkbox" name="ethnicity" value="Hispanic/Latino American"> Hispanic/Latino American</label>
    <label><input type="checkbox" name="ethnicity" value="White American"> White American</label>
    <label><input type="checkbox" name="ethnicity" value="Native American or other Indigenous culture"> Native American or other Indigenous culture</label>
    <label><input type="checkbox" name="ethnicity" value="Other"> Other</label>
  </div>

  <div class="survey-block">
    <h3>What regional dialect do you believe is closest to the way you speak?</h3>
    <label><input type="radio" name="dialect" value="Midwestern U.S."> Midwestern U.S.</label>
    <label><input type="radio" name="dialect" value="Northeastern U.S."> Northeastern U.S.</label>
    <label><input type="radio" name="dialect" value="Northwestern U.S."> Northwestern U.S.</label>
    <label><input type="radio" name="dialect" value="Southeastern U.S."> Southeastern U.S.</label>
    <label><input type="radio" name="dialect" value="Southwestern U.S."> Southwestern U.S.</label>
  </div>

  <div class="survey-block">
    <h3>What is/are your first language(s)?</h3>
    <label><input type="radio" name="firstLang" value="English"> English</label>
    <label><input type="radio" name="firstLang" value="English and another language"> English and another language</label>

    <div id="otherLangBox" style="display:none; margin-top:0.5rem;">
      <p>Please enter the language(s) besides English:</p>
      <textarea id="otherLangText"></textarea>
    </div>
  </div>



  <div class="survey-block">
    <h3>What is your gender?</h3>
    <label><input type="radio" name="gender" value="Male"> Male</label>
    <label><input type="radio" name="gender" value="Female"> Female</label>
    <label><input type="radio" name="gender" value="Non-binary"> Non-binary</label>
    <label><input type="radio" name="gender" value="Other"> Other</label>
  </div>

  <div class="survey-block">
    <h3>Do you have any speech or hearing disorders?</h3>
    <label><input type="radio" name="speech" value="No"> No</label>
    <label><input type="radio" name="speech" value="Yes"> Yes</label>
    <label><input type="radio" name="speech" value="Prefer not to say"> Prefer not to say</label>

    <div id="speechDescBox" style="display:none; margin-top:0.5rem;">
      <p>Please briefly describe the speech or hearing disorder:</p>
      <textarea id="speechDescText"></textarea>
    </div>
  </div>



  <div class="survey-block">
    <h3>Have you been diagnosed as neurodivergent by a medical professional?</h3>
    <label><input type="radio" name="neuro" value="No"> No</label>
    <label><input type="radio" name="neuro" value="Yes"> Yes</label>
    <label><input type="radio" name="neuro" value="Prefer not to say"> Prefer not to say</label>

    <div id="neuroDescBox" style="display:none; margin-top:0.5rem;">
      <p>Please briefly state the neurodivergence you were diagnosed with:</p>
      <textarea id="neuroDescText"></textarea>
    </div>
  </div>

  <div class="survey-block">
    <h3>How often do you use AI-based software or AI voice assistants?</h3>
    <label><input type="radio" name="aiUse" value="Never"> Never</label>
    <label><input type="radio" name="aiUse" value="Less than once per week"> Less than once per week</label>
    <label><input type="radio" name="aiUse" value="A few times per week"> A few times per week</label>
    <label><input type="radio" name="aiUse" value="About once per day"> About once per day</label>
    <label><input type="radio" name="aiUse" value="Several times per day"> Several times per day</label>
  </div>



  <div class="survey-block">
    <h3>Which technologies do you use regularly?</h3>
    <label><input type="checkbox" name="tech" value="ChatGPT Voice Assistant"> ChatGPT Voice Assistant</label>
    <label><input type="checkbox" name="tech" value="Google Gemini Voice"> Google Gemini Voice</label>
    <label><input type="checkbox" name="tech" value="Amazon Alexa"> Amazon Alexa</label>
    <label><input type="checkbox" name="tech" value="Apple Siri"> Apple Siri</label>
    <label><input type="checkbox" name="tech" value="Microsoft Cortana"> Microsoft Cortana</label>
    <label><input type="checkbox" name="tech" value="Voice-based navigation apps"> Voice-based navigation apps</label>
    <label><input type="checkbox" name="tech" value="Other text-to-speech software"> Other text-to-speech software</label>
    <label><input type="checkbox" name="tech" value="None of the above"> None of the above</label>
  </div>

  <div class="survey-block">
    <h3>What is your attitude towards AI-based software or AI voice assistants?</h3>

    <label>
      <input type="radio" name="aiAttitude" value="Extremely negative">
      Extremely negative
    </label>

    <label>
      <input type="radio" name="aiAttitude" value="Negative">
      Negative
    </label>

    <label>
      <input type="radio" name="aiAttitude" value="Neutral">
      Neutral
    </label>

    <label>
      <input type="radio" name="aiAttitude" value="Positive">
      Positive
    </label>

    <label>
      <input type="radio" name="aiAttitude" value="Extremely positive">
      Extremely positive
    </label>
  </div>

  <button id="demographicsSubmitBtn">Finish</button>
</section>


<!-- ===============================
      THANK YOU
=============================== -->
<section id="thanks">
  <h2>Thank you!</h2>
</section>


<script>
  
/* ===============================
   Firebase Init 
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyBDOb-3I8TD3ZjBxtqyQNBF8YFIuIAdsKc",
  authDomain: "slm-experiment-dev.firebaseapp.com",
  projectId: "slm-experiment-dev",
  storageBucket: "slm-experiment-dev.firebasestorage.app",
  messagingSenderId: "762879513861",
  appId: "1:762879513861:web:3b67a55dc2ba727308536c",
  measurementId: "G-9WYB65Z78J"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const storage = firebase.storage();



/* ===============================
   Trial definitions (20 trials)
================================ */
const trials = [
  // Medication
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Fact",
    question: "What‚Äôs the dosage for the medication, Levaquin?"
  },
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Risk",
    question: "Does the medication Corgard have any dangerous side effects?"
  },
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Advice",
    question: "Should I take the medication Topamax if I‚Äôm already taking Tylenol?"
  },
  {
    domain: "Medication",
    context: "You want to learn information about a new medication the doctor mentioned.",
    type: "Estimation",
    question: "What‚Äôs the cost for the medication, Relenza?"
  },

  // Health
  {
    domain: "Health",
    context: "You‚Äôre interested in learning more about common health disorders.",
    type: "Fact",
    question: "What are symptoms of stroke?"
  },
  {
    domain: "Health",
    context: "You‚Äôre interested in learning more about common health disorders.",
    type: "Risk",
    question: "Is cancer hereditary?"
  },
  {
    domain: "Health",
    context: "You‚Äôre interested in learning more about common health disorders.",
    type: "Advice",
    question: "What should I do to reduce my risk of diabetes?"
  },
  {
    domain: "Health",
    context: "You‚Äôre interested in learning more about common health disorders.",
    type: "Estimation",
    question: "If my dad has heart disease, what are the chances I‚Äôll get it too?"
  },

  // Career
  {
    domain: "Career",
    context: "You‚Äôre interested in a career change.",
    type: "Fact",
    question: "How commonly do people switch jobs into healthcare?"
  },
  {
    domain: "Career",
    context: "You‚Äôre interested in a career change.",
    type: "Risk",
    question: "What are the job-related health risks in finance?"
  },
  {
    domain: "Career",
    context: "You‚Äôre interested in a career change.",
    type: "Advice",
    question: "Would I earn enough as an educational administrator?"
  },
  {
    domain: "Career",
    context: "You‚Äôre interested in a career change.",
    type: "Estimation",
    question: "How many years of training would I need to do to get into computer science?"
  },

  // Travel
  {
    domain: "Travel",
    context: "You‚Äôre interested in learning more about the world.",
    type: "Fact",
    question: "Where is the world‚Äôs tallest tree?"
  },
  {
    domain: "Travel",
    context: "You‚Äôre interested in learning more about the world.",
    type: "Risk",
    question: "What are the risks in going in a cave?"
  },
  {
    domain: "Travel",
    context: "You‚Äôre interested in learning more about the world.",
    type: "Advice",
    question: "Should I visit the world‚Äôs tallest volcano on a vacation?"
  },
  {
    domain: "Travel",
    context: "You‚Äôre interested in learning more about the world.",
    type: "Estimation",
    question: "How long would it take to reach the top of the world‚Äôs tallest mountain?"
  },

  // Cooking
  {
    domain: "Cooking",
    context: "You‚Äôre interested in trying a new recipe.",
    type: "Fact",
    question: "What temperature do I need to cook chicken to?"
  },
  {
    domain: "Cooking",
    context: "You‚Äôre interested in trying a new recipe.",
    type: "Risk",
    question: "Can I drink milk that‚Äôs been expired for 2 days?"
  },
  {
    domain: "Cooking",
    context: "You‚Äôre interested in trying a new recipe.",
    type: "Advice",
    question: "If I have an allergy to peanuts, should I eat peanut oil?"
  },
  {
    domain: "Cooking",
    context: "You‚Äôre interested in trying a new recipe.",
    type: "Estimation",
    question: "How much is a dash of salt?"
  }
];

/* ===============================
   Variables + DOM Elements
================================ */
let userId = null;
let condition = null; // "natural" or "robotic"
let currentTrialIndex = 0;
let micStream = null;
let pendingTurnData = null;

const recordBtn = document.getElementById("recordBtn");
const skipTrialBtn = document.getElementById("skipTrialBtn");
const surveyBtn = document.getElementById("surveyBtn");
const statusEl = document.getElementById("status");
const responseAudio = document.getElementById("responseAudio");
responseAudio.playbackRate = 1.0;

let hasPlayedResponse = false;

// Test trial elements
const testRecordBtn = document.getElementById("testRecordBtn");
const testContinueBtn = document.getElementById("testContinueBtn");
const testStatusEl = document.getElementById("testStatus");
const testResponseAudio = document.getElementById("testResponseAudio");
testResponseAudio.playbackRate = 1.0;

let testHasPlayedResponse = false;

// Mic test elements
const micTestRecordBtn = document.getElementById("micTestRecordBtn");
const micTestContinueBtn = document.getElementById("micTestContinueBtn");
const micTestStatusEl = document.getElementById("micTestStatus");
const micTestPlayback = document.getElementById("micTestPlayback");

let micTestRecorder, micTestChunks = [];

responseAudio.addEventListener("ratechange", () => {
  responseAudio.playbackRate = 1.0;
});

// üîí Hard lock: prevent seeking / skipping
// üîí Prevent seeking (allow natural playback only)
responseAudio.addEventListener("timeupdate", () => {
  if (responseAudio._lastTime == null) {
    responseAudio._lastTime = responseAudio.currentTime;
    return;
  }

  const delta = responseAudio.currentTime - responseAudio._lastTime;

  // allow small forward progress (~natural playback)
  if (delta < -0.2 || delta > 0.5) {
    responseAudio.currentTime = responseAudio._lastTime;
  } else {
    responseAudio._lastTime = responseAudio.currentTime;
  }
});

//  Disable replay 
responseAudio.addEventListener("play", () => {
  if (hasPlayedResponse) {
    responseAudio.pause();
    responseAudio.currentTime = responseAudio.duration;
  }
});


// Test trial audio event listeners
testResponseAudio.addEventListener("ratechange", () => {
  testResponseAudio.playbackRate = 1.0;
});

// üîí Hard lock: prevent seeking / skipping for test trial
testResponseAudio.addEventListener("timeupdate", () => {
  if (testResponseAudio._lastTime == null) {
    testResponseAudio._lastTime = testResponseAudio.currentTime;
    return;
  }

  const delta = testResponseAudio.currentTime - testResponseAudio._lastTime;

  // allow small forward progress (~natural playback)
  if (delta < -0.2 || delta > 0.5) {
    testResponseAudio.currentTime = testResponseAudio._lastTime;
  } else {
    testResponseAudio._lastTime = testResponseAudio.currentTime;
  }
});

//  Disable replay for test trial
testResponseAudio.addEventListener("play", () => {
  if (testHasPlayedResponse) {
    testResponseAudio.pause();
    testResponseAudio.currentTime = testResponseAudio.duration;
  }
});

// ‚úÖ Enable Continue only after full listen for test trial
testResponseAudio.addEventListener("ended", () => {
  if (testResponseAudio.duration && testResponseAudio.duration > 0.5) {
    testHasPlayedResponse = true;

    // lock audio at end
    testResponseAudio.currentTime = testResponseAudio.duration;
    testResponseAudio.pause();

    // Hide visualization and show continue button
    document.getElementById("testAudioVisualization").style.display = "none";
    testContinueBtn.style.display = "inline-block";
  }
});
const interaction = document.getElementById("interaction");
const postSurvey = document.getElementById("postSurvey");
const trialSurvey = document.getElementById("trialSurvey");
const systemImpression = document.getElementById("systemImpression");
const readAloud = document.getElementById("readAloud");
const readAloudRecordBtn = document.getElementById("readAloudRecordBtn");
const readAloudContinueBtn = document.getElementById("readAloudContinueBtn");
const readAloudStatus = document.getElementById("readAloudStatus");




const trialCounterEl = document.getElementById("trialCounter");
const trialContextEl = document.getElementById("trialContext");
const trialQuestionEl = document.getElementById("trialQuestion");


/* ===============================
   SCREEN LOGIC
================================ */

// Welcome ‚Üí Environment
document.getElementById("welcomeContinueBtn").onclick = () => {
  document.getElementById("welcome").classList.remove("active");
  document.getElementById("environment").classList.add("active");
};

// Environment confirmation logic
const envCheckbox = document.getElementById("envConfirm");
const envContinueBtn = document.getElementById("envContinueBtn");

envCheckbox.onchange = () => {
  envContinueBtn.disabled = !envCheckbox.checked;
};

// Environment ‚Üí Audio Calibration
envContinueBtn.onclick = () => {
  document.getElementById("environment").classList.remove("active");

  const calibrationSection = document.getElementById("audioCalibration");
  calibrationSection.classList.add("active");

  // üîß FORCE audio to initialize after becoming visible
  const calibrationAudio = document.getElementById("calibrationAudio");
  calibrationAudio.load();
};


// After audio is heard ‚Üí show per-trial survey
surveyBtn.onclick = () => {
  interaction.classList.remove("active");
  trialSurvey.classList.add("active");
};

// Audio calibration ‚Üí Microphone Preview
document.getElementById("calibrationContinueBtn").onclick = async () => {

  const answer = document.querySelector(
    'input[name="calibrationCheck"]:checked'
  );

  if (!answer) {
    alert("Please answer the question before continuing.");
    return;
  }

  if (answer.value !== "yellow") {
    alert("That answer is incorrect. Please listen again and try once more.");
    return;
  }

  document.getElementById("audioCalibration").classList.remove("active");
  document.getElementById("micPreview").classList.add("active");
};

// Microphone Preview ‚Üí Microphone Accept
document.getElementById("micPreviewContinueBtn").onclick = () => {
  document.getElementById("micPreview").classList.remove("active");
  document.getElementById("micAccept").classList.add("active");
};

// Microphone Accept ‚Üí Microphone Test
document.getElementById("micAcceptContinueBtn").onclick = async () => {
  const statusEl = document.getElementById("micAcceptStatus");
  statusEl.textContent = "Requesting microphone access...";

  try {
    if (!micStream) {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }
    statusEl.textContent = "Microphone access granted.";

    // Initialize user data here
    condition = Math.random() < 0.5 ? "natural" : "robotic";
    userId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

    trials.sort(() => Math.random() - 0.5);

    await db.collection("users").doc(userId).set({
      userId,
      condition,
      createdAt: new Date(),
      audioCalibrationPassed: true,
      trialOrder: trials.map(t => ({
        domain: t.domain,
        type: t.type
      }))
    });

    document.getElementById("micAccept").classList.remove("active");
    document.getElementById("micTest").classList.add("active");

  } catch (err) {
    console.error("Microphone access error:", err);
    statusEl.textContent = "Microphone access denied or failed. Please try again.";
  }
};

// Microphone Test ‚Üí Read Aloud
document.getElementById("micTestContinueBtn").onclick = () => {
  document.getElementById("micTest").classList.remove("active");
  document.getElementById("readAloud").classList.add("active");
};



/* ===============================
   DEMOGRAPHICS CONDITIONAL LOGIC
================================ */

// First language ‚Üí show other language box
document.querySelectorAll('input[name="firstLang"]').forEach(radio => {
  radio.addEventListener("change", () => {
    document.getElementById("otherLangBox").style.display =
      radio.value === "English and another language" ? "block" : "none";
  });
});

// Speech disorder ‚Üí show description
document.querySelectorAll('input[name="speech"]').forEach(radio => {
  radio.addEventListener("change", () => {
    document.getElementById("speechDescBox").style.display =
      radio.value === "Yes" ? "block" : "none";
  });
});

// Neurodivergence ‚Üí show description
document.querySelectorAll('input[name="neuro"]').forEach(radio => {
  radio.addEventListener("change", () => {
    document.getElementById("neuroDescBox").style.display =
      radio.value === "Yes" ? "block" : "none";
  });
});



/* ===============================
   READ-ALOUD ‚Üí TASK INSTRUCTIONS
================================ */
readAloudContinueBtn.onclick = () => {
  readAloud.classList.remove("active");
  document.getElementById("taskInstructions").classList.add("active");
};


document.getElementById("taskInstructionsContinueBtn").onclick = () => {
  document.getElementById("taskInstructions").classList.remove("active");
  
  // Reset test trial elements
  document.getElementById("testAudioVisualization").style.display = "none";
  testStatusEl.innerHTML = "";
  testRecordBtn.disabled = false;
  testRecordBtn.textContent = "Record";
  testContinueBtn.style.display = "none";
  testHasPlayedResponse = false;
  testResponseAudio._lastTime = 0;
  
  document.getElementById("testTrial").classList.add("active");
};

// Test trial continue ‚Üí Start experimental trials
document.getElementById("testContinueBtn").onclick = () => {
  document.getElementById("testTrial").classList.remove("active");

  currentTrialIndex = 0;
  loadTrial(currentTrialIndex);
  interaction.classList.add("active");
};


/* ===============================
   SYSTEM IMPRESSIONS ‚Üí ANTHROPOMORPHISM
================================ */

document.getElementById("systemImpressionContinueBtn").onclick = async () => {
  const getVal = name =>
    document.querySelector(`input[name="${name}"]:checked`)?.value || null;

  const data = {
    knowledgeable: getVal("knowledgeable"),
    bestInterest: getVal("bestInterest"),
    honest: getVal("honest"),
    unbiased: getVal("unbiased"),
    trustworthiness: getVal("trustworthiness"),
    collaborator: getVal("collaborator"),
    timestamp: new Date()
  };

  if (Object.values(data).some(v => v === null)) {
    alert("Please answer all questions before continuing.");
    return;
  }

  await db.collection("users").doc(userId).set(
    { systemImpression: data },
    { merge: true }
  );

  systemImpression.classList.remove("active");
  postSurvey.classList.add("active");
};



/* ===============================
   Load Trial
================================ */
function loadTrial(i) {
  const t = trials[i];
  trialCounterEl.textContent = `Trial ${i + 1} / ${trials.length}`;
  trialContextEl.textContent = t.context;
  trialQuestionEl.textContent = t.question;

  // reset audio (Safari-safe)
  responseAudio.pause();
  responseAudio.src = "";
  responseAudio.load();

  surveyBtn.style.display = "none";
  recordBtn.disabled = false;
  recordBtn.textContent = "Record";
  pendingTurnData = null;

  // Hide audio visualization
  document.getElementById("audioVisualization").style.display = "none";
  statusEl.innerHTML = "";

  // üîÑ reset audio lock
  hasPlayedResponse = false;
  responseAudio.onended = null;
  responseAudio.controls = true;
  responseAudio._lastTime = 0;
  ["accuracy", "risk", "validate"].forEach(name => {
    document.querySelectorAll(`input[name="${name}"]`).forEach(r => (r.checked = false));
  });
}

/* ===============================
   Recording
================================ */
let mediaRecorder, chunks = [];

// Test trial recording variables
let testMediaRecorder, testChunks = [];

recordBtn.onclick = async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {

    if (!micStream) {
      alert("Microphone not initialized. Please refresh the page.");
      return;
    }

    mediaRecorder = new MediaRecorder(micStream);
    chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = handleRecordingStop;
    mediaRecorder.start();

    recordBtn.textContent = "Stop";
    statusEl.innerHTML = "Recording...";
  } else {
    mediaRecorder.stop();
    recordBtn.textContent = "Recorded";
    statusEl.innerHTML = `<div class="dots"><span></span><span></span><span></span></div>`;
    recordBtn.disabled = true;
  }
};

// Skip trial handler
skipTrialBtn.onclick = () => {
  currentTrialIndex++;
  if (currentTrialIndex < trials.length) {
    loadTrial(currentTrialIndex);
    // Reset UI
    recordBtn.textContent = "Record";
    recordBtn.disabled = false;
    statusEl.innerHTML = "";
    responseAudio.src = "";
    responseAudio.style.display = "none";
    surveyBtn.style.display = "none";
    document.getElementById("audioVisualization").style.display = "none";
  } else {
    // All trials skipped, go to system impressions
    systemImpression.classList.add("active");
    interaction.classList.remove("active");
  }
};

// Test trial recording handler
testRecordBtn.onclick = async () => {
  if (!testMediaRecorder || testMediaRecorder.state === "inactive") {

    if (!micStream) {
      alert("Microphone not initialized. Please refresh the page.");
      return;
    }

    testMediaRecorder = new MediaRecorder(micStream);
    testChunks = [];
    testMediaRecorder.ondataavailable = e => testChunks.push(e.data);
    testMediaRecorder.onstop = handleTestRecordingStop;
    testMediaRecorder.start();

    testRecordBtn.textContent = "Stop";
    testStatusEl.innerHTML = "Recording...";
  } else {
    testMediaRecorder.stop();
    testRecordBtn.textContent = "Recorded";
    testStatusEl.innerHTML = `<div class="dots"><span></span><span></span><span></span></div>`;
    testRecordBtn.disabled = true;
  }
};

// Microphone test recording handler
micTestRecordBtn.onclick = async () => {
  if (!micTestRecorder || micTestRecorder.state === "inactive") {
    if (!micStream) {
      alert("Microphone not initialized. Please refresh the page.");
      return;
    }

    micTestRecorder = new MediaRecorder(micStream);
    micTestChunks = [];
    micTestRecorder.ondataavailable = e => micTestChunks.push(e.data);
    micTestRecorder.onstop = () => {
      const blob = new Blob(micTestChunks, { type: "audio/webm" });
      const audioURL = URL.createObjectURL(blob);
      micTestPlayback.src = audioURL;
      micTestStatusEl.textContent = "Recording complete! Click play to hear yourself.";
      micTestContinueBtn.style.display = "inline-block";
    };

    micTestRecorder.start();
    micTestRecordBtn.textContent = "Stop";
    micTestStatusEl.textContent = "Recording... say a few words";
    micTestContinueBtn.style.display = "none";
  } else {
    micTestRecorder.stop();
    micTestRecordBtn.textContent = "Recorded";
    micTestRecordBtn.disabled = true;
  }
};


/* ===============================
   READ-ALOUD RECORDING (NO AI)
================================ */
let readAloudRecorder;
let readAloudChunks = [];
let readAloudCompleted = false;

readAloudRecordBtn.onclick = async () => {
  if (readAloudCompleted) return;

  if (!readAloudRecorder || readAloudRecorder.state === "inactive") {
    // ‚úÖ REUSE EXISTING MIC STREAM
    readAloudRecorder = new MediaRecorder(micStream);
    readAloudChunks = [];

    readAloudRecorder.ondataavailable = e => {
      if (e.data.size > 0) readAloudChunks.push(e.data);
    };

    readAloudRecorder.onstop = async () => {
      readAloudStatus.textContent = "Saving recording‚Ä¶";
      readAloudRecordBtn.disabled = true;
      readAloudRecordBtn.textContent = "Recorded";
      readAloudCompleted = true;

      try {
        const mimeType = readAloudRecorder.mimeType || "audio/webm";
        const ext = mimeType.includes("mp4") ? "mp4" : "webm";
        const ts = Date.now();

        const blob = new Blob(readAloudChunks, { type: mimeType });

        const storageRef = storage.ref(
          `users/${userId}/passage_reading_${ts}.${ext}`
        );

        await storageRef.put(blob, { contentType: mimeType });
        const audioURL = await storageRef.getDownloadURL();

        await db.collection("users").doc(userId).set(
          { passageReadingURL: audioURL },
          { merge: true }
        );

        readAloudStatus.textContent = "Recording saved.";
        readAloudContinueBtn.disabled = false;

      } catch (err) {
        console.error("Passage recording save error:", err);
        readAloudStatus.textContent =
          "Error saving recording. Please refresh and try again.";
      } finally {
        readAloudChunks = [];
      }
    };

    readAloudRecorder.start();
    readAloudRecordBtn.textContent = "Stop";
    readAloudStatus.textContent = "Recording‚Ä¶ please read aloud.";
  } else {
    readAloudRecorder.stop();
  }
};



/* ===============================
   HANDLE RECORDING STOP
================================ */
async function handleRecordingStop() {
  const ts = Date.now();
  const t = trials[currentTrialIndex];

  try {
    // Upload user recording (webm)
    const userBlob = new Blob(chunks, { type: "audio/webm" });
    const userRef = storage.ref(
      `users/${userId}/trial_${currentTrialIndex + 1}_${t.domain}_${t.type}_user_${ts}.webm`
    );
    await userRef.put(userBlob);
    const userAudioURL = await userRef.getDownloadURL();

    // Call backend to get model reply (.webm)
    const response = await fetch("https://callopenai-ks3vpjhzoq-uc.a.run.app", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ audio: userAudioURL, userId })
    });

    const data = await response.json();
    if (data.error) {
      statusEl.textContent = "‚ö†Ô∏è Error: " + data.error;
      recordBtn.disabled = false;
      return;
    }

    // Convert model .webm ‚Üí WAV
    let wavLocalURL = await audioWebmToWavURL(data.audio);

    // Apply robotic DSP ONLY if needed
    if (condition === "robotic") {
      wavLocalURL = await applyRoboticEffect(wavLocalURL);
    }

    // Upload WAV to Firebase
    const wavBlob = await fetch(wavLocalURL).then(r => r.blob());
    const replyRef = storage.ref(
      `users/${userId}/trial_${currentTrialIndex + 1}_${t.domain}_${t.type}_reply_${ts}.wav`
    );
    await replyRef.put(wavBlob, { contentType: "audio/wav" });
    const wavFirebaseURL = await replyRef.getDownloadURL();

    // Save for per-trial survey
    pendingTurnData = {
      userAudioURL,
      replyAudioURL: wavFirebaseURL,
      modelText: data.text || ""
    };

    // Play WAV (forced, single playback)
    responseAudio.src = wavFirebaseURL;
    statusEl.innerHTML = "";
    
    // Set up ended event listener to show continue button
    responseAudio.addEventListener("ended", () => {
      if (responseAudio.duration && responseAudio.duration > 0.5) {
        hasPlayedResponse = true;

        // lock audio at end
        responseAudio.currentTime = responseAudio.duration;
        responseAudio.pause();

        // Hide visualization and show continue button
        document.getElementById("audioVisualization").style.display = "none";
        surveyBtn.style.display = "inline-block";
      }
    });
    
    // Show audio visualization
    const audioVisualization = document.getElementById("audioVisualization");
    const waveform = document.getElementById("waveform");
    audioVisualization.style.display = "block";
    
    // Animate waveform during playback
    const animateWaveform = () => {
      if (!responseAudio.paused && !responseAudio.ended) {
        const progress = (responseAudio.currentTime / responseAudio.duration) * 100;
        waveform.style.width = progress + "%";
        requestAnimationFrame(animateWaveform);
      }
    };
    
    responseAudio.addEventListener("play", () => {
      waveform.style.width = "0%";
      animateWaveform();
    });
    
    await responseAudio.play();

  } catch (err) {
    console.error("Recording stop error:", err);
    statusEl.textContent = "‚ö†Ô∏è Error occurred. Please try again.";
  } finally {
    recordBtn.disabled = true;
  }
}

/* ===============================
   HANDLE TEST RECORDING STOP
================================ */
async function handleTestRecordingStop() {
  const ts = Date.now();

  try {
    // Upload test user recording (webm)
    const testUserBlob = new Blob(testChunks, { type: "audio/webm" });
    const testUserRef = storage.ref(
      `users/${userId}/test_trial_user_${ts}.webm`
    );
    await testUserRef.put(testUserBlob);
    const testUserAudioURL = await testUserRef.getDownloadURL();

    // Call backend to get model reply (.webm)
    const response = await fetch("https://callopenai-ks3vpjhzoq-uc.a.run.app", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ audio: testUserAudioURL, userId })
    });

    const data = await response.json();
    if (data.error) {
      testStatusEl.textContent = "‚ö†Ô∏è Error: " + data.error;
      testRecordBtn.disabled = false;
      return;
    }

    // Convert model .webm ‚Üí WAV
    let testWavLocalURL = await audioWebmToWavURL(data.audio);

    // Apply robotic DSP ONLY if needed
    if (condition === "robotic") {
      testWavLocalURL = await applyRoboticEffect(testWavLocalURL);
    }

    // Upload WAV to Firebase
    const testWavBlob = await fetch(testWavLocalURL).then(r => r.blob());
    const testReplyRef = storage.ref(
      `users/${userId}/test_trial_reply_${ts}.wav`
    );
    await testReplyRef.put(testWavBlob, { contentType: "audio/wav" });
    const testWavFirebaseURL = await testReplyRef.getDownloadURL();

    // Play WAV (forced, single playback)
    testResponseAudio.src = testWavFirebaseURL;
    testStatusEl.innerHTML = "";
    
    // Show test audio visualization
    const testAudioVisualization = document.getElementById("testAudioVisualization");
    const testWaveform = document.getElementById("testWaveform");
    testAudioVisualization.style.display = "block";
    
    // Animate test waveform during playback
    const animateTestWaveform = () => {
      if (!testResponseAudio.paused && !testResponseAudio.ended) {
        const progress = (testResponseAudio.currentTime / testResponseAudio.duration) * 100;
        testWaveform.style.width = progress + "%";
        requestAnimationFrame(animateTestWaveform);
      }
    };
    
    testResponseAudio.addEventListener("play", () => {
      testWaveform.style.width = "0%";
      animateTestWaveform();
    });
    
    await testResponseAudio.play();

  } catch (err) {
    console.error("Test recording stop error:", err);
    testStatusEl.textContent = "‚ö†Ô∏è Error occurred. Please try again.";
  } finally {
    testRecordBtn.disabled = true;
  }
}

/* ===============================
   ROBOTIC DSP EFFECT
================================ */
async function applyRoboticEffect(url) {
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const decoded = await ctx.decodeAudioData(arrayBuffer);
  ctx.close();

  const offline = new OfflineAudioContext(
    decoded.numberOfChannels,
    decoded.length,
    decoded.sampleRate
  );

  const src = offline.createBufferSource();
  src.buffer = decoded;

  // Mild AM
  const osc = offline.createOscillator();
  osc.type = "sine";
  osc.frequency.value = 110;

  const modGain = offline.createGain();
  modGain.gain.value = 0.15;

  osc.connect(modGain.gain);
  src.connect(modGain);

  // Light noise
  const noiseBuffer = offline.createBuffer(1, decoded.length, decoded.sampleRate);
  const noiseData = noiseBuffer.getChannelData(0);
  for (let i = 0; i < noiseData.length; i++) {
    noiseData[i] = (Math.random() - 0.5) * 0.02;
  }

  const noise = offline.createBufferSource();
  noise.buffer = noiseBuffer;

  const noiseGain = offline.createGain();
  noiseGain.gain.value = 0.01;

  noise.connect(noiseGain);

  const mix = offline.createGain();
  modGain.connect(mix);
  noiseGain.connect(mix);
  mix.connect(offline.destination);

  osc.start(0);
  src.start(0);
  noise.start(0);

  const rendered = await offline.startRendering();
  return audioBufferToWavURL(rendered);
}

/* ===============================
   WEBM ‚Üí WAV HELPER
================================ */
async function audioWebmToWavURL(webmUrl) {
  const response = await fetch(webmUrl);
  const arrayBuffer = await response.arrayBuffer();

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const decoded = await ctx.decodeAudioData(arrayBuffer);
  ctx.close();

  return audioBufferToWavURL(decoded);
}

/* ===============================
   WAV EXPORT HELPER
================================ */
function audioBufferToWavURL(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const length = buffer.length * numChannels * 2 + 44;

  const arrayBuffer = new ArrayBuffer(length);
  const view = new DataView(arrayBuffer);

  let pos = 0;
  const write = s => { for (let i = 0; i < s.length; i++) view.setUint8(pos++, s.charCodeAt(i)); };

  write("RIFF");
  view.setUint32(pos, 36 + buffer.length * numChannels * 2, true); pos += 4;
  write("WAVE");
  write("fmt ");
  view.setUint32(pos, 16, true); pos += 4;
  view.setUint16(pos, 1, true); pos += 2;
  view.setUint16(pos, numChannels, true); pos += 2;
  view.setUint32(pos, sampleRate, true); pos += 4;
  view.setUint32(pos, sampleRate * numChannels * 2, true); pos += 4;
  view.setUint16(pos, numChannels * 2, true); pos += 2;
  view.setUint16(pos, 16, true); pos += 2;
  write("data");
  view.setUint32(pos, buffer.length * numChannels * 2, true); pos += 4;

  const channels = [];
  for (let c = 0; c < numChannels; c++) {
    channels.push(buffer.getChannelData(c));
  }

  for (let i = 0; i < buffer.length; i++) {
    for (let c = 0; c < numChannels; c++) {
      let sample = channels[c][i];
      sample = Math.max(-1, Math.min(1, sample));
      view.setInt16(pos, sample * 32767, true);
      pos += 2;
    }
  }

  return URL.createObjectURL(new Blob([arrayBuffer], { type: "audio/wav" }));
}

/* ===============================
   PER-TRIAL SURVEY HANDLER
================================ */
document.getElementById("trialSurveyNextBtn").onclick = async () => {
  const acc = document.querySelector('input[name="accuracy"]:checked');
  const risk = document.querySelector('input[name="risk"]:checked');
  const val = document.querySelector('input[name="validate"]:checked');

  if (!acc || !risk || !val) {
    alert("Please answer all three questions before continuing.");
    return;
  }
  if (!pendingTurnData) {
    console.warn("No pending turn data for this trial.");
    return;
  }

  const trial = trials[currentTrialIndex];

  const docData = {
    userId,
    condition,
    trialIndex: currentTrialIndex,
    trialNumber: currentTrialIndex + 1,
    domain: trial.domain,
    context: trial.context,
    questionType: trial.type,
    questionText: trial.question,
    userAudioURL: pendingTurnData.userAudioURL,
    replyAudioURL: pendingTurnData.replyAudioURL,
    modelText: pendingTurnData.modelText,
    perceivedAccuracy: acc.value,
    perceivedRisk: risk.value,
    followupValidation: val.value,
    timestamp: new Date()
  };

  await db.collection("users").doc(userId).collection("conversation").add(docData);

  trialSurvey.classList.remove("active");

  if (currentTrialIndex < trials.length - 1) {
    currentTrialIndex++;
    loadTrial(currentTrialIndex);
    interaction.classList.add("active");
  } else {
    systemImpression.classList.add("active");
  }
};



/* ===============================
   FINAL ANTHROPOMORPHISM SURVEY
================================ */
document.getElementById("submitBtn").onclick = async () => {

  const getVal = (name) =>
    document.querySelector(`input[name="${name}"]:checked`)?.value || null;

  const authenticity = getVal("authenticity");
  const humanism = getVal("humanism");
  const awareness = getVal("awareness");
  const realism = getVal("realism");
  const competence = getVal("competence");

  if (!authenticity || !humanism || !awareness || !realism || !competence) {
    alert("Please answer all questions before submitting.");
    return;
  }

  await db.collection("users").doc(userId).set(
    {
      anthropomorphism: {
        authenticity,
        humanism,
        awareness,
        realism,
        competence,
        totalScore:
          Number(authenticity) +
          Number(humanism) +
          Number(awareness) +
          Number(realism) +
          Number(competence),
        timestamp: new Date()
      }
    },
    { merge: true }
  );


  postSurvey.classList.remove("active");
  document.getElementById("demographics").classList.add("active");
};

document.getElementById("demographicsSubmitBtn").onclick = async () => {

  const getRadio = name =>
    document.querySelector(`input[name="${name}"]:checked`)?.value || null;

  const getCheckboxes = name =>
    Array.from(document.querySelectorAll(`input[name="${name}"]:checked`))
      .map(cb => cb.value);

      const demographicsData = {
        age: getRadio("age"),
        ethnicity: getCheckboxes("ethnicity"),
        dialect: getRadio("dialect"),
        firstLanguage: getRadio("firstLang"),
        otherLanguages:
          getRadio("firstLang") === "English and another language"
            ? document.getElementById("otherLangText").value.trim()
            : "",

        gender: getRadio("gender"),

        speechDisorder: getRadio("speech"),
        speechDescription:
          getRadio("speech") === "Yes"
            ? document.getElementById("speechDescText").value.trim()
            : "",

        neurodivergent: getRadio("neuro"),
        neuroDescription:
          getRadio("neuro") === "Yes"
            ? document.getElementById("neuroDescText").value.trim()
            : "",

        technologiesUsed: getCheckboxes("tech"),
        aiUseFrequency: getRadio("aiUse"),
        aiAttitude: getRadio("aiAttitude"),

        timestamp: new Date()
      };

      if (
        !demographicsData.age ||
        demographicsData.ethnicity.length === 0 ||
        !demographicsData.dialect ||
        !demographicsData.firstLanguage ||
        !demographicsData.gender ||
        !demographicsData.speechDisorder ||
        !demographicsData.neurodivergent ||
        demographicsData.technologiesUsed.length === 0 ||
        !demographicsData.aiUseFrequency ||
        !demographicsData.aiAttitude
      ) {
        alert("Please answer all demographic questions.");
        return;
      }

      // Require descriptions if Yes
      if (
        demographicsData.speechDisorder === "Yes" &&
        !demographicsData.speechDescription
      ) {
        alert("Please describe your speech or hearing disorder.");
        return;
      }

      if (
        demographicsData.neurodivergent === "Yes" &&
        !demographicsData.neuroDescription
      ) {
        alert("Please describe your neurodivergence.");
        return;
      }

      if (
        demographicsData.firstLanguage === "English and another language" &&
        !demographicsData.otherLanguages
      ) {
        alert("Please specify your other language(s).");
        return;
      }


  await db.collection("users").doc(userId).set(
    { demographics: demographicsData },
    { merge: true }
  );

  document.getElementById("demographics").classList.remove("active");
  document.getElementById("thanks").classList.add("active");
};

const calibrationAudio = document.getElementById("calibrationAudio");

calibrationAudio.addEventListener("error", () => {
  alert(
    "Audio calibration file failed to load.\n" +
    "Please refresh the page or contact the researcher."
  );
});


// add 2  attention checks after 5th and 15th trials 
// fix how data is saved 

</script>

</body>
</html>


